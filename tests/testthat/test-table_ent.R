# Tests all ENT variants.

library(scda)

adsl <- synthetic_cdisc_data("rcd_2022_02_28")$adsl

testthat::test_that("ENT01_IT is produced correctly", {
  adsl$REGION1 <- droplevels(adsl$REGION1) # nolint
  adsl$COUNTRY <- droplevels(adsl$COUNTRY) # nolint
  adsl <- adsl[order(adsl$REGION1, adsl$COUNTRY, adsl$INVID), ]

  l <- basic_table() %>%
    split_cols_by("ARM") %>%
    add_colcounts() %>%
    add_overall_col(label = "All Patients") %>%
    split_rows_by("REGION1") %>%
    summarize_row_groups() %>%
    split_rows_by("COUNTRY") %>%
    summarize_row_groups() %>%
    split_rows_by("INVID") %>%
    summarize_row_groups()

  tbl <- build_table(l, adsl)
  result <- prune_table(tbl, all_zero_or_na, stop_depth = 4)

  result_matrix <- to_string_matrix(result)
  expected_matrix <- structure(
    c(
      "", "", "Africa", "NGA",
      "INV ID NGA-1", "INV ID NGA-11", "INV ID NGA-12", "INV ID NGA-17", "INV ID NGA-2",
      "INV ID NGA-4", "INV ID NGA-5", "INV ID NGA-6", "Asia",
      "CHN", "INV ID CHN-1", "INV ID CHN-10", "INV ID CHN-11", "INV ID CHN-12",
      "INV ID CHN-13", "INV ID CHN-14", "INV ID CHN-15", "INV ID CHN-16",
      "INV ID CHN-17", "INV ID CHN-18", "INV ID CHN-2", "INV ID CHN-3", "INV ID CHN-4",
      "INV ID CHN-5", "INV ID CHN-6", "INV ID CHN-7", "INV ID CHN-8",
      "INV ID CHN-9", "PAK", "INV ID PAK-1", "INV ID PAK-11", "INV ID PAK-12",
      "INV ID PAK-13", "INV ID PAK-14", "INV ID PAK-15", "INV ID PAK-2",
      "INV ID PAK-4", "INV ID PAK-5", "JPN", "INV ID JPN-1", "INV ID JPN-11",
      "INV ID JPN-12", "INV ID JPN-14", "INV ID JPN-17", "INV ID JPN-18",
      "INV ID JPN-2", "INV ID JPN-3", "INV ID JPN-5", "INV ID JPN-6", "Eurasia",
      "RUS", "INV ID RUS-1", "INV ID RUS-11", "INV ID RUS-12",
      "INV ID RUS-13", "INV ID RUS-14", "INV ID RUS-16", "INV ID RUS-18", "INV ID RUS-2",
      "INV ID RUS-3", "INV ID RUS-4", "INV ID RUS-5", "INV ID RUS-6",
      "INV ID RUS-7", "Europe", "GBR", "INV ID GBR-1", "INV ID GBR-11",
      "INV ID GBR-13", "INV ID GBR-15", "INV ID GBR-17", "INV ID GBR-6",
      "North America", "USA", "INV ID USA-1", "INV ID USA-11", "INV ID USA-12",
      "INV ID USA-14", "INV ID USA-15", "INV ID USA-17", "INV ID USA-19",
      "INV ID USA-2", "INV ID USA-3", "INV ID USA-4", "INV ID USA-5", "INV ID USA-6",
      "INV ID USA-8", "INV ID USA-9", "CAN", "INV ID CAN-1",
      "INV ID CAN-11", "INV ID CAN-14", "INV ID CAN-4", "INV ID CAN-5", "South America",
      "BRA", "INV ID BRA-1", "INV ID BRA-11", "INV ID BRA-12",
      "INV ID BRA-13", "INV ID BRA-14", "INV ID BRA-15", "INV ID BRA-2", "INV ID BRA-3",
      "INV ID BRA-4", "INV ID BRA-5", "INV ID BRA-6", "INV ID BRA-7",
      "A: Drug X", "(N=134)", "8 (6.0%)", "8 (6.0%)", "3 (2.2%)",
      "1 (0.7%)", "0 (0.0%)", "2 (1.5%)", "1 (0.7%)",
      "1 (0.7%)", "0 (0.0%)", "0 (0.0%)", "91 (67.9%)", "74 (55.2%)",
      "21 (15.7%)", "0 (0.0%)", "12 (9.0%)", "4 (3.0%)",
      "2 (1.5%)", "4 (3.0%)", "2 (1.5%)", "0 (0.0%)", "4 (3.0%)",
      "1 (0.7%)", "9 (6.7%)", "5 (3.7%)", "3 (2.2%)",
      "4 (3.0%)", "1 (0.7%)", "0 (0.0%)", "1 (0.7%)", "1 (0.7%)",
      "12 (9.0%)", "2 (1.5%)", "4 (3.0%)", "2 (1.5%)",
      "1 (0.7%)", "1 (0.7%)", "1 (0.7%)", "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "5 (3.7%)", "2 (1.5%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)", "0 (0.0%)", "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)", "1 (0.7%)", "5 (3.7%)",
      "5 (3.7%)", "1 (0.7%)", "0 (0.0%)", "0 (0.0%)", "1 (0.7%)",
      "0 (0.0%)", "1 (0.7%)", "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)", "0 (0.0%)", "1 (0.7%)", "0 (0.0%)",
      "4 (3.0%)", "4 (3.0%)", "2 (1.5%)", "0 (0.0%)",
      "1 (0.7%)", "1 (0.7%)", "0 (0.0%)", "0 (0.0%)", "13 (9.7%)",
      "10 (7.5%)", "1 (0.7%)", "4 (3.0%)", "1 (0.7%)",
      "1 (0.7%)", "0 (0.0%)", "1 (0.7%)", "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)", "0 (0.0%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)", "3 (2.2%)", "1 (0.7%)", "1 (0.7%)",
      "1 (0.7%)", "0 (0.0%)", "0 (0.0%)", "13 (9.7%)",
      "13 (9.7%)", "4 (3.0%)", "4 (3.0%)", "0 (0.0%)", "1 (0.7%)",
      "1 (0.7%)", "1 (0.7%)", "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)", "1 (0.7%)", "0 (0.0%)", "B: Placebo",
      "(N=134)", "7 (5.2%)", "7 (5.2%)", "3 (2.2%)",
      "2 (1.5%)", "1 (0.7%)", "0 (0.0%)", "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)", "94 (70.1%)", "81 (60.4%)",
      "20 (14.9%)", "1 (0.7%)", "20 (14.9%)", "3 (2.2%)", "6 (4.5%)",
      "2 (1.5%)", "0 (0.0%)", "3 (2.2%)", "4 (3.0%)",
      "0 (0.0%)", "4 (3.0%)", "1 (0.7%)", "3 (2.2%)", "3 (2.2%)",
      "3 (2.2%)", "5 (3.7%)", "1 (0.7%)", "2 (1.5%)",
      "9 (6.7%)", "4 (3.0%)", "3 (2.2%)", "0 (0.0%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)", "0 (0.0%)", "1 (0.7%)",
      "0 (0.0%)", "4 (3.0%)", "2 (1.5%)", "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)", "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)", "0 (0.0%)", "8 (6.0%)", "8 (6.0%)",
      "0 (0.0%)", "2 (1.5%)", "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)", "0 (0.0%)", "1 (0.7%)", "0 (0.0%)",
      "2 (1.5%)", "1 (0.7%)", "0 (0.0%)", "0 (0.0%)",
      "3 (2.2%)", "3 (2.2%)", "0 (0.0%)", "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)", "1 (0.7%)", "15 (11.2%)",
      "13 (9.7%)", "4 (3.0%)", "2 (1.5%)", "2 (1.5%)", "0 (0.0%)",
      "1 (0.7%)", "1 (0.7%)", "0 (0.0%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)", "1 (0.7%)", "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "2 (1.5%)", "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)", "0 (0.0%)", "7 (5.2%)", "7 (5.2%)",
      "2 (1.5%)", "0 (0.0%)", "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)", "1 (0.7%)", "2 (1.5%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)", "0 (0.0%)", "C: Combination",
      "(N=132)", "11 (8.3%)", "11 (8.3%)", "4 (3.0%)", "3 (2.3%)",
      "1 (0.8%)", "0 (0.0%)", "0 (0.0%)", "1 (0.8%)",
      "1 (0.8%)", "1 (0.8%)", "83 (62.9%)", "64 (48.5%)", "16 (12.1%)",
      "0 (0.0%)", "16 (12.1%)", "1 (0.8%)", "0 (0.0%)",
      "3 (2.3%)", "4 (3.0%)", "3 (2.3%)", "3 (2.3%)", "2 (1.5%)",
      "3 (2.3%)", "5 (3.8%)", "3 (2.3%)", "4 (3.0%)",
      "0 (0.0%)", "1 (0.8%)", "0 (0.0%)", "0 (0.0%)", "10 (7.6%)",
      "4 (3.0%)", "2 (1.5%)", "0 (0.0%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)", "2 (1.5%)", "1 (0.8%)", "1 (0.8%)",
      "9 (6.8%)", "1 (0.8%)", "3 (2.3%)", "1 (0.8%)",
      "0 (0.0%)", "2 (1.5%)", "0 (0.0%)", "1 (0.8%)", "0 (0.0%)",
      "1 (0.8%)", "0 (0.0%)", "6 (4.5%)", "6 (4.5%)",
      "0 (0.0%)", "2 (1.5%)", "0 (0.0%)", "0 (0.0%)", "1 (0.8%)",
      "0 (0.0%)", "0 (0.0%)", "0 (0.0%)", "1 (0.8%)",
      "1 (0.8%)", "0 (0.0%)", "0 (0.0%)", "1 (0.8%)", "2 (1.5%)",
      "2 (1.5%)", "1 (0.8%)", "1 (0.8%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)", "0 (0.0%)", "20 (15.2%)", "17 (12.9%)",
      "5 (3.8%)", "3 (2.3%)", "3 (2.3%)", "0 (0.0%)",
      "1 (0.8%)", "0 (0.0%)", "1 (0.8%)", "1 (0.8%)", "1 (0.8%)",
      "1 (0.8%)", "0 (0.0%)", "0 (0.0%)", "1 (0.8%)",
      "0 (0.0%)", "3 (2.3%)", "0 (0.0%)", "1 (0.8%)", "0 (0.0%)",
      "1 (0.8%)", "1 (0.8%)", "10 (7.6%)", "10 (7.6%)",
      "2 (1.5%)", "4 (3.0%)", "0 (0.0%)", "0 (0.0%)", "1 (0.8%)",
      "0 (0.0%)", "0 (0.0%)", "0 (0.0%)", "1 (0.8%)",
      "1 (0.8%)", "0 (0.0%)", "1 (0.8%)", "All Patients", "(N=400)",
      "26 (6.5%)", "26 (6.5%)", "10 (2.5%)", "6 (1.5%)",
      "2 (0.5%)", "2 (0.5%)", "2 (0.5%)", "2 (0.5%)", "1 (0.2%)",
      "1 (0.2%)", "268 (67.0%)", "219 (54.8%)", "57 (14.2%)",
      "1 (0.2%)", "48 (12.0%)", "8 (2.0%)", "8 (2.0%)", "9 (2.2%)",
      "6 (1.5%)", "6 (1.5%)", "11 (2.8%)", "3 (0.8%)",
      "16 (4.0%)", "11 (2.8%)", "9 (2.2%)", "11 (2.8%)", "4 (1.0%)",
      "6 (1.5%)", "2 (0.5%)", "3 (0.8%)", "31 (7.8%)",
      "10 (2.5%)", "9 (2.2%)", "2 (0.5%)", "2 (0.5%)", "1 (0.2%)",
      "1 (0.2%)", "3 (0.8%)", "2 (0.5%)", "1 (0.2%)",
      "18 (4.5%)", "5 (1.2%)", "3 (0.8%)", "1 (0.2%)", "1 (0.2%)",
      "2 (0.5%)", "1 (0.2%)", "1 (0.2%)", "1 (0.2%)",
      "2 (0.5%)", "1 (0.2%)", "19 (4.8%)", "19 (4.8%)", "1 (0.2%)",
      "4 (1.0%)", "1 (0.2%)", "1 (0.2%)", "1 (0.2%)",
      "2 (0.5%)", "1 (0.2%)", "1 (0.2%)", "1 (0.2%)", "3 (0.8%)",
      "1 (0.2%)", "1 (0.2%)", "1 (0.2%)", "9 (2.2%)",
      "9 (2.2%)", "3 (0.8%)", "2 (0.5%)", "1 (0.2%)", "1 (0.2%)",
      "1 (0.2%)", "1 (0.2%)", "48 (12.0%)", "40 (10.0%)",
      "10 (2.5%)", "9 (2.2%)", "6 (1.5%)", "1 (0.2%)", "2 (0.5%)",
      "2 (0.5%)", "1 (0.2%)", "1 (0.2%)", "2 (0.5%)",
      "2 (0.5%)", "1 (0.2%)", "1 (0.2%)", "1 (0.2%)", "1 (0.2%)",
      "8 (2.0%)", "2 (0.5%)", "2 (0.5%)", "1 (0.2%)",
      "2 (0.5%)", "1 (0.2%)", "30 (7.5%)", "30 (7.5%)", "8 (2.0%)",
      "8 (2.0%)", "1 (0.2%)", "1 (0.2%)", "2 (0.5%)",
      "1 (0.2%)", "2 (0.5%)", "2 (0.5%)", "2 (0.5%)", "1 (0.2%)",
      "1 (0.2%)", "1 (0.2%)"
    ),
    .Dim = c(112L, 5L)
  )
  testthat::expect_identical(result_matrix, expected_matrix)
})

testthat::test_that("ENT01a_IT is produced correctly", {
  adsl$REGION1 <- droplevels(adsl$REGION1) # nolint
  adsl$COUNTRY <- droplevels(adsl$COUNTRY) # nolint
  adsl <- adsl[order(adsl$REGION1, adsl$COUNTRY, adsl$INVID), ]

  l <- basic_table() %>%
    split_cols_by("ARM") %>%
    add_colcounts() %>%
    add_overall_col(label = "All Patients") %>%
    split_rows_by("COUNTRY") %>%
    summarize_row_groups() %>%
    split_rows_by("INVID") %>%
    summarize_row_groups()

  result <- build_table(l, adsl)

  result_matrix <- to_string_matrix(result)
  expected_matrix <- structure(
    c(
      "", "", "CHN", "INV ID CHN-1", "INV ID CHN-10",
      "INV ID CHN-11", "INV ID CHN-12", "INV ID CHN-13", "INV ID CHN-14",
      "INV ID CHN-15", "INV ID CHN-16", "INV ID CHN-17", "INV ID CHN-18", "INV ID CHN-2",
      "INV ID CHN-3", "INV ID CHN-4", "INV ID CHN-5", "INV ID CHN-6",
      "INV ID CHN-7", "INV ID CHN-8", "INV ID CHN-9", "USA", "INV ID USA-1",
      "INV ID USA-11", "INV ID USA-12", "INV ID USA-14", "INV ID USA-15",
      "INV ID USA-17", "INV ID USA-19", "INV ID USA-2", "INV ID USA-3", "INV ID USA-4",
      "INV ID USA-5", "INV ID USA-6", "INV ID USA-8", "INV ID USA-9",
      "BRA", "INV ID BRA-1", "INV ID BRA-11", "INV ID BRA-12", "INV ID BRA-13",
      "INV ID BRA-14", "INV ID BRA-15", "INV ID BRA-2", "INV ID BRA-3",
      "INV ID BRA-4", "INV ID BRA-5", "INV ID BRA-6", "INV ID BRA-7", "PAK",
      "INV ID PAK-1", "INV ID PAK-11", "INV ID PAK-12", "INV ID PAK-13",
      "INV ID PAK-14", "INV ID PAK-15", "INV ID PAK-2", "INV ID PAK-4", "INV ID PAK-5",
      "NGA", "INV ID NGA-1", "INV ID NGA-11", "INV ID NGA-12",
      "INV ID NGA-17", "INV ID NGA-2", "INV ID NGA-4", "INV ID NGA-5", "INV ID NGA-6",
      "RUS", "INV ID RUS-1", "INV ID RUS-11", "INV ID RUS-12",
      "INV ID RUS-13", "INV ID RUS-14", "INV ID RUS-16", "INV ID RUS-18", "INV ID RUS-2",
      "INV ID RUS-3", "INV ID RUS-4", "INV ID RUS-5", "INV ID RUS-6",
      "INV ID RUS-7", "JPN", "INV ID JPN-1", "INV ID JPN-11", "INV ID JPN-12",
      "INV ID JPN-14", "INV ID JPN-17", "INV ID JPN-18", "INV ID JPN-2",
      "INV ID JPN-3", "INV ID JPN-5", "INV ID JPN-6", "GBR", "INV ID GBR-1",
      "INV ID GBR-11", "INV ID GBR-13", "INV ID GBR-15", "INV ID GBR-17",
      "INV ID GBR-6", "CAN", "INV ID CAN-1", "INV ID CAN-11", "INV ID CAN-14",
      "INV ID CAN-4", "INV ID CAN-5", "A: Drug X", "(N=134)",
      "74 (55.2%)", "21 (15.7%)", "0 (0.0%)", "12 (9.0%)", "4 (3.0%)",
      "2 (1.5%)", "4 (3.0%)", "2 (1.5%)", "0 (0.0%)",
      "4 (3.0%)", "1 (0.7%)", "9 (6.7%)", "5 (3.7%)", "3 (2.2%)",
      "4 (3.0%)", "1 (0.7%)", "0 (0.0%)", "1 (0.7%)",
      "1 (0.7%)", "10 (7.5%)", "1 (0.7%)", "4 (3.0%)", "1 (0.7%)",
      "1 (0.7%)", "0 (0.0%)", "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)", "0 (0.0%)", "0 (0.0%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)", "13 (9.7%)", "4 (3.0%)",
      "4 (3.0%)", "0 (0.0%)", "1 (0.7%)", "1 (0.7%)", "1 (0.7%)",
      "1 (0.7%)", "0 (0.0%)", "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)", "12 (9.0%)", "2 (1.5%)", "4 (3.0%)",
      "2 (1.5%)", "1 (0.7%)", "1 (0.7%)", "1 (0.7%)",
      "1 (0.7%)", "0 (0.0%)", "0 (0.0%)", "8 (6.0%)", "3 (2.2%)",
      "1 (0.7%)", "0 (0.0%)", "2 (1.5%)", "1 (0.7%)",
      "1 (0.7%)", "0 (0.0%)", "0 (0.0%)", "5 (3.7%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)", "1 (0.7%)", "0 (0.0%)",
      "1 (0.7%)", "1 (0.7%)", "0 (0.0%)", "0 (0.0%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)", "0 (0.0%)", "5 (3.7%)",
      "2 (1.5%)", "0 (0.0%)", "0 (0.0%)", "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)", "0 (0.0%)", "1 (0.7%)",
      "1 (0.7%)", "4 (3.0%)", "2 (1.5%)", "0 (0.0%)", "1 (0.7%)",
      "1 (0.7%)", "0 (0.0%)", "0 (0.0%)", "3 (2.2%)",
      "1 (0.7%)", "1 (0.7%)", "1 (0.7%)", "0 (0.0%)", "0 (0.0%)",
      "B: Placebo", "(N=134)", "81 (60.4%)", "20 (14.9%)",
      "1 (0.7%)", "20 (14.9%)", "3 (2.2%)", "6 (4.5%)", "2 (1.5%)",
      "0 (0.0%)", "3 (2.2%)", "4 (3.0%)", "0 (0.0%)",
      "4 (3.0%)", "1 (0.7%)", "3 (2.2%)", "3 (2.2%)", "3 (2.2%)",
      "5 (3.7%)", "1 (0.7%)", "2 (1.5%)", "13 (9.7%)",
      "4 (3.0%)", "2 (1.5%)", "2 (1.5%)", "0 (0.0%)", "1 (0.7%)",
      "1 (0.7%)", "0 (0.0%)", "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "1 (0.7%)", "1 (0.7%)", "0 (0.0%)", "0 (0.0%)",
      "7 (5.2%)", "2 (1.5%)", "0 (0.0%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)", "0 (0.0%)", "1 (0.7%)", "2 (1.5%)",
      "1 (0.7%)", "0 (0.0%)", "0 (0.0%)", "0 (0.0%)",
      "9 (6.7%)", "4 (3.0%)", "3 (2.2%)", "0 (0.0%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)", "0 (0.0%)", "1 (0.7%)",
      "0 (0.0%)", "7 (5.2%)", "3 (2.2%)", "2 (1.5%)", "1 (0.7%)",
      "0 (0.0%)", "1 (0.7%)", "0 (0.0%)", "0 (0.0%)",
      "0 (0.0%)", "8 (6.0%)", "0 (0.0%)", "2 (1.5%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)", "1 (0.7%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)", "2 (1.5%)", "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "4 (3.0%)", "2 (1.5%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)", "0 (0.0%)", "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)", "0 (0.0%)", "3 (2.2%)",
      "0 (0.0%)", "1 (0.7%)", "0 (0.0%)", "0 (0.0%)", "1 (0.7%)",
      "1 (0.7%)", "2 (1.5%)", "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)", "0 (0.0%)", "C: Combination", "(N=132)",
      "64 (48.5%)", "16 (12.1%)", "0 (0.0%)", "16 (12.1%)",
      "1 (0.8%)", "0 (0.0%)", "3 (2.3%)", "4 (3.0%)", "3 (2.3%)",
      "3 (2.3%)", "2 (1.5%)", "3 (2.3%)", "5 (3.8%)",
      "3 (2.3%)", "4 (3.0%)", "0 (0.0%)", "1 (0.8%)", "0 (0.0%)",
      "0 (0.0%)", "17 (12.9%)", "5 (3.8%)", "3 (2.3%)",
      "3 (2.3%)", "0 (0.0%)", "1 (0.8%)", "0 (0.0%)", "1 (0.8%)",
      "1 (0.8%)", "1 (0.8%)", "1 (0.8%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.8%)", "0 (0.0%)", "10 (7.6%)", "2 (1.5%)",
      "4 (3.0%)", "0 (0.0%)", "0 (0.0%)", "1 (0.8%)",
      "0 (0.0%)", "0 (0.0%)", "0 (0.0%)", "1 (0.8%)", "1 (0.8%)",
      "0 (0.0%)", "1 (0.8%)", "10 (7.6%)", "4 (3.0%)",
      "2 (1.5%)", "0 (0.0%)", "0 (0.0%)", "0 (0.0%)", "0 (0.0%)",
      "2 (1.5%)", "1 (0.8%)", "1 (0.8%)", "11 (8.3%)",
      "4 (3.0%)", "3 (2.3%)", "1 (0.8%)", "0 (0.0%)", "0 (0.0%)",
      "1 (0.8%)", "1 (0.8%)", "1 (0.8%)", "6 (4.5%)",
      "0 (0.0%)", "2 (1.5%)", "0 (0.0%)", "0 (0.0%)", "1 (0.8%)",
      "0 (0.0%)", "0 (0.0%)", "0 (0.0%)", "1 (0.8%)",
      "1 (0.8%)", "0 (0.0%)", "0 (0.0%)", "1 (0.8%)", "9 (6.8%)",
      "1 (0.8%)", "3 (2.3%)", "1 (0.8%)", "0 (0.0%)",
      "2 (1.5%)", "0 (0.0%)", "1 (0.8%)", "0 (0.0%)", "1 (0.8%)",
      "0 (0.0%)", "2 (1.5%)", "1 (0.8%)", "1 (0.8%)",
      "0 (0.0%)", "0 (0.0%)", "0 (0.0%)", "0 (0.0%)", "3 (2.3%)",
      "0 (0.0%)", "1 (0.8%)", "0 (0.0%)", "1 (0.8%)",
      "1 (0.8%)", "All Patients", "(N=400)", "219 (54.8%)", "57 (14.2%)",
      "1 (0.2%)", "48 (12.0%)", "8 (2.0%)", "8 (2.0%)",
      "9 (2.2%)", "6 (1.5%)", "6 (1.5%)", "11 (2.8%)", "3 (0.8%)",
      "16 (4.0%)", "11 (2.8%)", "9 (2.2%)", "11 (2.8%)",
      "4 (1.0%)", "6 (1.5%)", "2 (0.5%)", "3 (0.8%)", "40 (10.0%)",
      "10 (2.5%)", "9 (2.2%)", "6 (1.5%)", "1 (0.2%)",
      "2 (0.5%)", "2 (0.5%)", "1 (0.2%)", "1 (0.2%)", "2 (0.5%)",
      "2 (0.5%)", "1 (0.2%)", "1 (0.2%)", "1 (0.2%)",
      "1 (0.2%)", "30 (7.5%)", "8 (2.0%)", "8 (2.0%)", "1 (0.2%)",
      "1 (0.2%)", "2 (0.5%)", "1 (0.2%)", "2 (0.5%)",
      "2 (0.5%)", "2 (0.5%)", "1 (0.2%)", "1 (0.2%)", "1 (0.2%)",
      "31 (7.8%)", "10 (2.5%)", "9 (2.2%)", "2 (0.5%)",
      "2 (0.5%)", "1 (0.2%)", "1 (0.2%)", "3 (0.8%)", "2 (0.5%)",
      "1 (0.2%)", "26 (6.5%)", "10 (2.5%)", "6 (1.5%)",
      "2 (0.5%)", "2 (0.5%)", "2 (0.5%)", "2 (0.5%)", "1 (0.2%)",
      "1 (0.2%)", "19 (4.8%)", "1 (0.2%)", "4 (1.0%)",
      "1 (0.2%)", "1 (0.2%)", "1 (0.2%)", "2 (0.5%)", "1 (0.2%)",
      "1 (0.2%)", "1 (0.2%)", "3 (0.8%)", "1 (0.2%)",
      "1 (0.2%)", "1 (0.2%)", "18 (4.5%)", "5 (1.2%)", "3 (0.8%)",
      "1 (0.2%)", "1 (0.2%)", "2 (0.5%)", "1 (0.2%)",
      "1 (0.2%)", "1 (0.2%)", "2 (0.5%)", "1 (0.2%)", "9 (2.2%)",
      "3 (0.8%)", "2 (0.5%)", "1 (0.2%)", "1 (0.2%)",
      "1 (0.2%)", "1 (0.2%)", "8 (2.0%)", "2 (0.5%)", "2 (0.5%)",
      "1 (0.2%)", "2 (0.5%)", "1 (0.2%)"
    ),
    .Dim = c(106L, 5L)
  )
  testthat::expect_identical(result_matrix, expected_matrix)
})

testthat::test_that("ENT02_IT is produced correctly", {
  adsl$REGION1 <- droplevels(adsl$REGION1) # nolint
  adsl$COUNTRY <- droplevels(adsl$COUNTRY) # nolint
  adsl <- adsl[order(adsl$REGION1, adsl$COUNTRY, adsl$INVID), ]

  adsl$INVID_INVNAM <- paste(adsl$INVID, adsl$INVNAM, sep = " / ") # nolint

  l <- basic_table() %>%
    split_cols_by("ARM") %>%
    add_colcounts() %>%
    add_overall_col(label = "All Patients") %>%
    split_rows_by("REGION1") %>%
    summarize_row_groups() %>%
    split_rows_by("COUNTRY") %>%
    summarize_row_groups() %>%
    split_rows_by("INVID_INVNAM") %>%
    summarize_row_groups()

  tbl <- build_table(l, adsl)
  result <- prune_table(tbl, all_zero_or_na, stop_depth = 4)

  result_matrix <- to_string_matrix(result)
  expected_matrix <- structure(
    c(
      "", "",
      "Africa", "NGA",
      "INV ID NGA-1 / Dr. NGA-1 Doe", "INV ID NGA-11 / Dr. NGA-11 Doe",
      "INV ID NGA-12 / Dr. NGA-12 Doe", "INV ID NGA-17 / Dr. NGA-17 Doe",
      "INV ID NGA-2 / Dr. NGA-2 Doe", "INV ID NGA-4 / Dr. NGA-4 Doe",
      "INV ID NGA-5 / Dr. NGA-5 Doe", "INV ID NGA-6 / Dr. NGA-6 Doe",
      "Asia", "CHN",
      "INV ID CHN-1 / Dr. CHN-1 Doe", "INV ID CHN-10 / Dr. CHN-10 Doe",
      "INV ID CHN-11 / Dr. CHN-11 Doe", "INV ID CHN-12 / Dr. CHN-12 Doe",
      "INV ID CHN-13 / Dr. CHN-13 Doe", "INV ID CHN-14 / Dr. CHN-14 Doe",
      "INV ID CHN-15 / Dr. CHN-15 Doe", "INV ID CHN-16 / Dr. CHN-16 Doe",
      "INV ID CHN-17 / Dr. CHN-17 Doe", "INV ID CHN-18 / Dr. CHN-18 Doe",
      "INV ID CHN-2 / Dr. CHN-2 Doe", "INV ID CHN-3 / Dr. CHN-3 Doe",
      "INV ID CHN-4 / Dr. CHN-4 Doe", "INV ID CHN-5 / Dr. CHN-5 Doe",
      "INV ID CHN-6 / Dr. CHN-6 Doe", "INV ID CHN-7 / Dr. CHN-7 Doe",
      "INV ID CHN-8 / Dr. CHN-8 Doe", "INV ID CHN-9 / Dr. CHN-9 Doe",
      "PAK", "INV ID PAK-1 / Dr. PAK-1 Doe",
      "INV ID PAK-11 / Dr. PAK-11 Doe", "INV ID PAK-12 / Dr. PAK-12 Doe",
      "INV ID PAK-13 / Dr. PAK-13 Doe", "INV ID PAK-14 / Dr. PAK-14 Doe",
      "INV ID PAK-15 / Dr. PAK-15 Doe", "INV ID PAK-2 / Dr. PAK-2 Doe",
      "INV ID PAK-4 / Dr. PAK-4 Doe", "INV ID PAK-5 / Dr. PAK-5 Doe",
      "JPN", "INV ID JPN-1 / Dr. JPN-1 Doe",
      "INV ID JPN-11 / Dr. JPN-11 Doe", "INV ID JPN-12 / Dr. JPN-12 Doe",
      "INV ID JPN-14 / Dr. JPN-14 Doe", "INV ID JPN-17 / Dr. JPN-17 Doe",
      "INV ID JPN-18 / Dr. JPN-18 Doe", "INV ID JPN-2 / Dr. JPN-2 Doe",
      "INV ID JPN-3 / Dr. JPN-3 Doe", "INV ID JPN-5 / Dr. JPN-5 Doe",
      "INV ID JPN-6 / Dr. JPN-6 Doe", "Eurasia",
      "RUS", "INV ID RUS-1 / Dr. RUS-1 Doe",
      "INV ID RUS-11 / Dr. RUS-11 Doe", "INV ID RUS-12 / Dr. RUS-12 Doe",
      "INV ID RUS-13 / Dr. RUS-13 Doe", "INV ID RUS-14 / Dr. RUS-14 Doe",
      "INV ID RUS-16 / Dr. RUS-16 Doe", "INV ID RUS-18 / Dr. RUS-18 Doe",
      "INV ID RUS-2 / Dr. RUS-2 Doe", "INV ID RUS-3 / Dr. RUS-3 Doe",
      "INV ID RUS-4 / Dr. RUS-4 Doe", "INV ID RUS-5 / Dr. RUS-5 Doe",
      "INV ID RUS-6 / Dr. RUS-6 Doe", "INV ID RUS-7 / Dr. RUS-7 Doe",
      "Europe", "GBR",
      "INV ID GBR-1 / Dr. GBR-1 Doe", "INV ID GBR-11 / Dr. GBR-11 Doe",
      "INV ID GBR-13 / Dr. GBR-13 Doe", "INV ID GBR-15 / Dr. GBR-15 Doe",
      "INV ID GBR-17 / Dr. GBR-17 Doe", "INV ID GBR-6 / Dr. GBR-6 Doe",
      "North America", "USA",
      "INV ID USA-1 / Dr. USA-1 Doe", "INV ID USA-11 / Dr. USA-11 Doe",
      "INV ID USA-12 / Dr. USA-12 Doe", "INV ID USA-14 / Dr. USA-14 Doe",
      "INV ID USA-15 / Dr. USA-15 Doe", "INV ID USA-17 / Dr. USA-17 Doe",
      "INV ID USA-19 / Dr. USA-19 Doe", "INV ID USA-2 / Dr. USA-2 Doe",
      "INV ID USA-3 / Dr. USA-3 Doe", "INV ID USA-4 / Dr. USA-4 Doe",
      "INV ID USA-5 / Dr. USA-5 Doe", "INV ID USA-6 / Dr. USA-6 Doe",
      "INV ID USA-8 / Dr. USA-8 Doe", "INV ID USA-9 / Dr. USA-9 Doe",
      "CAN", "INV ID CAN-1 / Dr. CAN-1 Doe",
      "INV ID CAN-11 / Dr. CAN-11 Doe", "INV ID CAN-14 / Dr. CAN-14 Doe",
      "INV ID CAN-4 / Dr. CAN-4 Doe", "INV ID CAN-5 / Dr. CAN-5 Doe",
      "South America", "BRA",
      "INV ID BRA-1 / Dr. BRA-1 Doe", "INV ID BRA-11 / Dr. BRA-11 Doe",
      "INV ID BRA-12 / Dr. BRA-12 Doe", "INV ID BRA-13 / Dr. BRA-13 Doe",
      "INV ID BRA-14 / Dr. BRA-14 Doe", "INV ID BRA-15 / Dr. BRA-15 Doe",
      "INV ID BRA-2 / Dr. BRA-2 Doe", "INV ID BRA-3 / Dr. BRA-3 Doe",
      "INV ID BRA-4 / Dr. BRA-4 Doe", "INV ID BRA-5 / Dr. BRA-5 Doe",
      "INV ID BRA-6 / Dr. BRA-6 Doe", "INV ID BRA-7 / Dr. BRA-7 Doe",
      "A: Drug X", "(N=134)",
      "8 (6.0%)", "8 (6.0%)",
      "3 (2.2%)", "1 (0.7%)",
      "0 (0.0%)", "2 (1.5%)",
      "1 (0.7%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)",
      "91 (67.9%)", "74 (55.2%)",
      "21 (15.7%)", "0 (0.0%)",
      "12 (9.0%)", "4 (3.0%)",
      "2 (1.5%)", "4 (3.0%)",
      "2 (1.5%)", "0 (0.0%)",
      "4 (3.0%)", "1 (0.7%)",
      "9 (6.7%)", "5 (3.7%)",
      "3 (2.2%)", "4 (3.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "1 (0.7%)", "1 (0.7%)",
      "12 (9.0%)", "2 (1.5%)",
      "4 (3.0%)", "2 (1.5%)",
      "1 (0.7%)", "1 (0.7%)",
      "1 (0.7%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)",
      "5 (3.7%)", "2 (1.5%)",
      "0 (0.0%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)",
      "1 (0.7%)", "5 (3.7%)",
      "5 (3.7%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "1 (0.7%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "4 (3.0%)", "4 (3.0%)",
      "2 (1.5%)", "0 (0.0%)",
      "1 (0.7%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)",
      "13 (9.7%)", "10 (7.5%)",
      "1 (0.7%)", "4 (3.0%)",
      "1 (0.7%)", "1 (0.7%)",
      "0 (0.0%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)",
      "3 (2.2%)", "1 (0.7%)",
      "1 (0.7%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)",
      "13 (9.7%)", "13 (9.7%)",
      "4 (3.0%)", "4 (3.0%)",
      "0 (0.0%)", "1 (0.7%)",
      "1 (0.7%)", "1 (0.7%)",
      "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "B: Placebo", "(N=134)",
      "7 (5.2%)", "7 (5.2%)",
      "3 (2.2%)", "2 (1.5%)",
      "1 (0.7%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)",
      "94 (70.1%)", "81 (60.4%)",
      "20 (14.9%)", "1 (0.7%)",
      "20 (14.9%)", "3 (2.2%)",
      "6 (4.5%)", "2 (1.5%)",
      "0 (0.0%)", "3 (2.2%)",
      "4 (3.0%)", "0 (0.0%)",
      "4 (3.0%)", "1 (0.7%)",
      "3 (2.2%)", "3 (2.2%)",
      "3 (2.2%)", "5 (3.7%)",
      "1 (0.7%)", "2 (1.5%)",
      "9 (6.7%)", "4 (3.0%)",
      "3 (2.2%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "4 (3.0%)", "2 (1.5%)",
      "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "8 (6.0%)",
      "8 (6.0%)", "0 (0.0%)",
      "2 (1.5%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "2 (1.5%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)",
      "3 (2.2%)", "3 (2.2%)",
      "0 (0.0%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "1 (0.7%)",
      "15 (11.2%)", "13 (9.7%)",
      "4 (3.0%)", "2 (1.5%)",
      "2 (1.5%)", "0 (0.0%)",
      "1 (0.7%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)",
      "1 (0.7%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)",
      "2 (1.5%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "7 (5.2%)", "7 (5.2%)",
      "2 (1.5%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "2 (1.5%)",
      "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)",
      "C: Combination", "(N=132)",
      "11 (8.3%)", "11 (8.3%)",
      "4 (3.0%)", "3 (2.3%)",
      "1 (0.8%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.8%)",
      "1 (0.8%)", "1 (0.8%)",
      "83 (62.9%)", "64 (48.5%)",
      "16 (12.1%)", "0 (0.0%)",
      "16 (12.1%)", "1 (0.8%)",
      "0 (0.0%)", "3 (2.3%)",
      "4 (3.0%)", "3 (2.3%)",
      "3 (2.3%)", "2 (1.5%)",
      "3 (2.3%)", "5 (3.8%)",
      "3 (2.3%)", "4 (3.0%)",
      "0 (0.0%)", "1 (0.8%)",
      "0 (0.0%)", "0 (0.0%)",
      "10 (7.6%)", "4 (3.0%)",
      "2 (1.5%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)",
      "0 (0.0%)", "2 (1.5%)",
      "1 (0.8%)", "1 (0.8%)",
      "9 (6.8%)", "1 (0.8%)",
      "3 (2.3%)", "1 (0.8%)",
      "0 (0.0%)", "2 (1.5%)",
      "0 (0.0%)", "1 (0.8%)",
      "0 (0.0%)", "1 (0.8%)",
      "0 (0.0%)", "6 (4.5%)",
      "6 (4.5%)", "0 (0.0%)",
      "2 (1.5%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.8%)",
      "0 (0.0%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.8%)",
      "1 (0.8%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.8%)",
      "2 (1.5%)", "2 (1.5%)",
      "1 (0.8%)", "1 (0.8%)",
      "0 (0.0%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)",
      "20 (15.2%)", "17 (12.9%)",
      "5 (3.8%)", "3 (2.3%)",
      "3 (2.3%)", "0 (0.0%)",
      "1 (0.8%)", "0 (0.0%)",
      "1 (0.8%)", "1 (0.8%)",
      "1 (0.8%)", "1 (0.8%)",
      "0 (0.0%)", "0 (0.0%)",
      "1 (0.8%)", "0 (0.0%)",
      "3 (2.3%)", "0 (0.0%)",
      "1 (0.8%)", "0 (0.0%)",
      "1 (0.8%)", "1 (0.8%)",
      "10 (7.6%)", "10 (7.6%)",
      "2 (1.5%)", "4 (3.0%)",
      "0 (0.0%)", "0 (0.0%)",
      "1 (0.8%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)",
      "1 (0.8%)", "1 (0.8%)",
      "0 (0.0%)", "1 (0.8%)",
      "All Patients", "(N=400)",
      "26 (6.5%)", "26 (6.5%)",
      "10 (2.5%)", "6 (1.5%)",
      "2 (0.5%)", "2 (0.5%)",
      "2 (0.5%)", "2 (0.5%)",
      "1 (0.2%)", "1 (0.2%)",
      "268 (67.0%)", "219 (54.8%)",
      "57 (14.2%)", "1 (0.2%)",
      "48 (12.0%)", "8 (2.0%)",
      "8 (2.0%)", "9 (2.2%)",
      "6 (1.5%)", "6 (1.5%)",
      "11 (2.8%)", "3 (0.8%)",
      "16 (4.0%)", "11 (2.8%)",
      "9 (2.2%)", "11 (2.8%)",
      "4 (1.0%)", "6 (1.5%)",
      "2 (0.5%)", "3 (0.8%)",
      "31 (7.8%)", "10 (2.5%)",
      "9 (2.2%)", "2 (0.5%)",
      "2 (0.5%)", "1 (0.2%)",
      "1 (0.2%)", "3 (0.8%)",
      "2 (0.5%)", "1 (0.2%)",
      "18 (4.5%)", "5 (1.2%)",
      "3 (0.8%)", "1 (0.2%)",
      "1 (0.2%)", "2 (0.5%)",
      "1 (0.2%)", "1 (0.2%)",
      "1 (0.2%)", "2 (0.5%)",
      "1 (0.2%)", "19 (4.8%)",
      "19 (4.8%)", "1 (0.2%)",
      "4 (1.0%)", "1 (0.2%)",
      "1 (0.2%)", "1 (0.2%)",
      "2 (0.5%)", "1 (0.2%)",
      "1 (0.2%)", "1 (0.2%)",
      "3 (0.8%)", "1 (0.2%)",
      "1 (0.2%)", "1 (0.2%)",
      "9 (2.2%)", "9 (2.2%)",
      "3 (0.8%)", "2 (0.5%)",
      "1 (0.2%)", "1 (0.2%)",
      "1 (0.2%)", "1 (0.2%)",
      "48 (12.0%)", "40 (10.0%)",
      "10 (2.5%)", "9 (2.2%)",
      "6 (1.5%)", "1 (0.2%)",
      "2 (0.5%)", "2 (0.5%)",
      "1 (0.2%)", "1 (0.2%)",
      "2 (0.5%)", "2 (0.5%)",
      "1 (0.2%)", "1 (0.2%)",
      "1 (0.2%)", "1 (0.2%)",
      "8 (2.0%)", "2 (0.5%)",
      "2 (0.5%)", "1 (0.2%)",
      "2 (0.5%)", "1 (0.2%)",
      "30 (7.5%)", "30 (7.5%)",
      "8 (2.0%)", "8 (2.0%)",
      "1 (0.2%)", "1 (0.2%)",
      "2 (0.5%)", "1 (0.2%)",
      "2 (0.5%)", "2 (0.5%)",
      "2 (0.5%)", "1 (0.2%)",
      "1 (0.2%)", "1 (0.2%)"
    ),
    .Dim = c(112L, 5L)
  )
  testthat::expect_identical(result_matrix, expected_matrix)
})

testthat::test_that("ENT02a_IT is produced correctly", {
  adsl$REGION1 <- droplevels(adsl$REGION1) # nolint
  adsl$COUNTRY <- droplevels(adsl$COUNTRY) # nolint
  adsl <- adsl[order(adsl$REGION1, adsl$COUNTRY, adsl$INVID), ]

  adsl$INVID_INVNAM <- paste(adsl$INVID, adsl$INVNAM, sep = " / ") # nolint

  l <- basic_table() %>%
    split_cols_by("ARM") %>%
    add_colcounts() %>%
    add_overall_col(label = "All Patients") %>%
    split_rows_by("COUNTRY") %>%
    summarize_row_groups() %>%
    split_rows_by("INVID_INVNAM") %>%
    summarize_row_groups()

  result <- build_table(l, adsl)

  result_matrix <- to_string_matrix(result)
  expected_matrix <- structure(
    c(
      "", "", "CHN",
      "INV ID CHN-1 / Dr. CHN-1 Doe", "INV ID CHN-10 / Dr. CHN-10 Doe",
      "INV ID CHN-11 / Dr. CHN-11 Doe", "INV ID CHN-12 / Dr. CHN-12 Doe", "INV ID CHN-13 / Dr. CHN-13 Doe",
      "INV ID CHN-14 / Dr. CHN-14 Doe", "INV ID CHN-15 / Dr. CHN-15 Doe",
      "INV ID CHN-16 / Dr. CHN-16 Doe", "INV ID CHN-17 / Dr. CHN-17 Doe", "INV ID CHN-18 / Dr. CHN-18 Doe",
      "INV ID CHN-2 / Dr. CHN-2 Doe", "INV ID CHN-3 / Dr. CHN-3 Doe",
      "INV ID CHN-4 / Dr. CHN-4 Doe", "INV ID CHN-5 / Dr. CHN-5 Doe", "INV ID CHN-6 / Dr. CHN-6 Doe",
      "INV ID CHN-7 / Dr. CHN-7 Doe", "INV ID CHN-8 / Dr. CHN-8 Doe",
      "INV ID CHN-9 / Dr. CHN-9 Doe", "USA", "INV ID USA-1 / Dr. USA-1 Doe",
      "INV ID USA-11 / Dr. USA-11 Doe", "INV ID USA-12 / Dr. USA-12 Doe",
      "INV ID USA-14 / Dr. USA-14 Doe", "INV ID USA-15 / Dr. USA-15 Doe", "INV ID USA-17 / Dr. USA-17 Doe",
      "INV ID USA-19 / Dr. USA-19 Doe", "INV ID USA-2 / Dr. USA-2 Doe",
      "INV ID USA-3 / Dr. USA-3 Doe", "INV ID USA-4 / Dr. USA-4 Doe", "INV ID USA-5 / Dr. USA-5 Doe",
      "INV ID USA-6 / Dr. USA-6 Doe", "INV ID USA-8 / Dr. USA-8 Doe",
      "INV ID USA-9 / Dr. USA-9 Doe", "BRA", "INV ID BRA-1 / Dr. BRA-1 Doe",
      "INV ID BRA-11 / Dr. BRA-11 Doe", "INV ID BRA-12 / Dr. BRA-12 Doe",
      "INV ID BRA-13 / Dr. BRA-13 Doe", "INV ID BRA-14 / Dr. BRA-14 Doe", "INV ID BRA-15 / Dr. BRA-15 Doe",
      "INV ID BRA-2 / Dr. BRA-2 Doe", "INV ID BRA-3 / Dr. BRA-3 Doe",
      "INV ID BRA-4 / Dr. BRA-4 Doe", "INV ID BRA-5 / Dr. BRA-5 Doe", "INV ID BRA-6 / Dr. BRA-6 Doe",
      "INV ID BRA-7 / Dr. BRA-7 Doe", "PAK",
      "INV ID PAK-1 / Dr. PAK-1 Doe", "INV ID PAK-11 / Dr. PAK-11 Doe", "INV ID PAK-12 / Dr. PAK-12 Doe",
      "INV ID PAK-13 / Dr. PAK-13 Doe", "INV ID PAK-14 / Dr. PAK-14 Doe",
      "INV ID PAK-15 / Dr. PAK-15 Doe", "INV ID PAK-2 / Dr. PAK-2 Doe", "INV ID PAK-4 / Dr. PAK-4 Doe",
      "INV ID PAK-5 / Dr. PAK-5 Doe", "NGA",
      "INV ID NGA-1 / Dr. NGA-1 Doe", "INV ID NGA-11 / Dr. NGA-11 Doe", "INV ID NGA-12 / Dr. NGA-12 Doe",
      "INV ID NGA-17 / Dr. NGA-17 Doe", "INV ID NGA-2 / Dr. NGA-2 Doe",
      "INV ID NGA-4 / Dr. NGA-4 Doe", "INV ID NGA-5 / Dr. NGA-5 Doe", "INV ID NGA-6 / Dr. NGA-6 Doe",
      "RUS", "INV ID RUS-1 / Dr. RUS-1 Doe",
      "INV ID RUS-11 / Dr. RUS-11 Doe", "INV ID RUS-12 / Dr. RUS-12 Doe", "INV ID RUS-13 / Dr. RUS-13 Doe",
      "INV ID RUS-14 / Dr. RUS-14 Doe", "INV ID RUS-16 / Dr. RUS-16 Doe",
      "INV ID RUS-18 / Dr. RUS-18 Doe", "INV ID RUS-2 / Dr. RUS-2 Doe", "INV ID RUS-3 / Dr. RUS-3 Doe",
      "INV ID RUS-4 / Dr. RUS-4 Doe", "INV ID RUS-5 / Dr. RUS-5 Doe",
      "INV ID RUS-6 / Dr. RUS-6 Doe", "INV ID RUS-7 / Dr. RUS-7 Doe", "JPN",
      "INV ID JPN-1 / Dr. JPN-1 Doe", "INV ID JPN-11 / Dr. JPN-11 Doe",
      "INV ID JPN-12 / Dr. JPN-12 Doe", "INV ID JPN-14 / Dr. JPN-14 Doe", "INV ID JPN-17 / Dr. JPN-17 Doe",
      "INV ID JPN-18 / Dr. JPN-18 Doe", "INV ID JPN-2 / Dr. JPN-2 Doe",
      "INV ID JPN-3 / Dr. JPN-3 Doe", "INV ID JPN-5 / Dr. JPN-5 Doe", "INV ID JPN-6 / Dr. JPN-6 Doe",
      "GBR", "INV ID GBR-1 / Dr. GBR-1 Doe",
      "INV ID GBR-11 / Dr. GBR-11 Doe", "INV ID GBR-13 / Dr. GBR-13 Doe", "INV ID GBR-15 / Dr. GBR-15 Doe",
      "INV ID GBR-17 / Dr. GBR-17 Doe", "INV ID GBR-6 / Dr. GBR-6 Doe",
      "CAN", "INV ID CAN-1 / Dr. CAN-1 Doe", "INV ID CAN-11 / Dr. CAN-11 Doe",
      "INV ID CAN-14 / Dr. CAN-14 Doe", "INV ID CAN-4 / Dr. CAN-4 Doe",
      "INV ID CAN-5 / Dr. CAN-5 Doe", "A: Drug X", "(N=134)",
      "74 (55.2%)", "21 (15.7%)",
      "0 (0.0%)", "12 (9.0%)", "4 (3.0%)",
      "2 (1.5%)", "4 (3.0%)",
      "2 (1.5%)", "0 (0.0%)", "4 (3.0%)",
      "1 (0.7%)", "9 (6.7%)",
      "5 (3.7%)", "3 (2.2%)", "4 (3.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "1 (0.7%)", "1 (0.7%)", "10 (7.5%)",
      "1 (0.7%)", "4 (3.0%)",
      "1 (0.7%)", "1 (0.7%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)", "13 (9.7%)",
      "4 (3.0%)", "4 (3.0%)",
      "0 (0.0%)", "1 (0.7%)", "1 (0.7%)",
      "1 (0.7%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "12 (9.0%)", "2 (1.5%)", "4 (3.0%)",
      "2 (1.5%)", "1 (0.7%)",
      "1 (0.7%)", "1 (0.7%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)",
      "8 (6.0%)", "3 (2.2%)", "1 (0.7%)",
      "0 (0.0%)", "2 (1.5%)",
      "1 (0.7%)", "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "5 (3.7%)",
      "1 (0.7%)", "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "1 (0.7%)", "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)", "0 (0.0%)",
      "5 (3.7%)", "2 (1.5%)",
      "0 (0.0%)", "0 (0.0%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)", "1 (0.7%)",
      "1 (0.7%)", "4 (3.0%)",
      "2 (1.5%)", "0 (0.0%)", "1 (0.7%)",
      "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "3 (2.2%)", "1 (0.7%)",
      "1 (0.7%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)", "B: Placebo",
      "(N=134)", "81 (60.4%)",
      "20 (14.9%)", "1 (0.7%)", "20 (14.9%)",
      "3 (2.2%)", "6 (4.5%)",
      "2 (1.5%)", "0 (0.0%)", "3 (2.2%)",
      "4 (3.0%)", "0 (0.0%)",
      "4 (3.0%)", "1 (0.7%)", "3 (2.2%)",
      "3 (2.2%)", "3 (2.2%)",
      "5 (3.7%)", "1 (0.7%)", "2 (1.5%)",
      "13 (9.7%)", "4 (3.0%)",
      "2 (1.5%)", "2 (1.5%)", "0 (0.0%)",
      "1 (0.7%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "1 (0.7%)",
      "1 (0.7%)", "0 (0.0%)", "0 (0.0%)",
      "7 (5.2%)", "2 (1.5%)",
      "0 (0.0%)", "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "2 (1.5%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)",
      "0 (0.0%)", "9 (6.7%)", "4 (3.0%)",
      "3 (2.2%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)",
      "0 (0.0%)", "7 (5.2%)", "3 (2.2%)",
      "2 (1.5%)", "1 (0.7%)",
      "0 (0.0%)", "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)",
      "8 (6.0%)", "0 (0.0%)", "2 (1.5%)",
      "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "2 (1.5%)", "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "4 (3.0%)",
      "2 (1.5%)", "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)",
      "3 (2.2%)", "0 (0.0%)", "1 (0.7%)",
      "0 (0.0%)", "0 (0.0%)",
      "1 (0.7%)", "1 (0.7%)", "2 (1.5%)",
      "1 (0.7%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.7%)", "0 (0.0%)",
      "C: Combination", "(N=132)",
      "64 (48.5%)", "16 (12.1%)", "0 (0.0%)",
      "16 (12.1%)", "1 (0.8%)",
      "0 (0.0%)", "3 (2.3%)", "4 (3.0%)",
      "3 (2.3%)", "3 (2.3%)",
      "2 (1.5%)", "3 (2.3%)", "5 (3.8%)",
      "3 (2.3%)", "4 (3.0%)",
      "0 (0.0%)", "1 (0.8%)", "0 (0.0%)",
      "0 (0.0%)", "17 (12.9%)",
      "5 (3.8%)", "3 (2.3%)", "3 (2.3%)",
      "0 (0.0%)", "1 (0.8%)",
      "0 (0.0%)", "1 (0.8%)", "1 (0.8%)",
      "1 (0.8%)", "1 (0.8%)",
      "0 (0.0%)", "0 (0.0%)", "1 (0.8%)",
      "0 (0.0%)", "10 (7.6%)",
      "2 (1.5%)", "4 (3.0%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.8%)",
      "0 (0.0%)", "0 (0.0%)", "0 (0.0%)",
      "1 (0.8%)", "1 (0.8%)",
      "0 (0.0%)", "1 (0.8%)", "10 (7.6%)",
      "4 (3.0%)", "2 (1.5%)",
      "0 (0.0%)", "0 (0.0%)", "0 (0.0%)",
      "0 (0.0%)", "2 (1.5%)",
      "1 (0.8%)", "1 (0.8%)", "11 (8.3%)",
      "4 (3.0%)", "3 (2.3%)",
      "1 (0.8%)", "0 (0.0%)", "0 (0.0%)",
      "1 (0.8%)", "1 (0.8%)",
      "1 (0.8%)", "6 (4.5%)", "0 (0.0%)",
      "2 (1.5%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.8%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)",
      "1 (0.8%)", "1 (0.8%)", "0 (0.0%)",
      "0 (0.0%)", "1 (0.8%)",
      "9 (6.8%)", "1 (0.8%)", "3 (2.3%)",
      "1 (0.8%)", "0 (0.0%)",
      "2 (1.5%)", "0 (0.0%)", "1 (0.8%)",
      "0 (0.0%)", "1 (0.8%)",
      "0 (0.0%)", "2 (1.5%)", "1 (0.8%)",
      "1 (0.8%)", "0 (0.0%)",
      "0 (0.0%)", "0 (0.0%)", "0 (0.0%)",
      "3 (2.3%)", "0 (0.0%)",
      "1 (0.8%)", "0 (0.0%)", "1 (0.8%)",
      "1 (0.8%)", "All Patients",
      "(N=400)", "219 (54.8%)", "57 (14.2%)",
      "1 (0.2%)", "48 (12.0%)",
      "8 (2.0%)", "8 (2.0%)", "9 (2.2%)",
      "6 (1.5%)", "6 (1.5%)",
      "11 (2.8%)", "3 (0.8%)", "16 (4.0%)",
      "11 (2.8%)", "9 (2.2%)",
      "11 (2.8%)", "4 (1.0%)", "6 (1.5%)",
      "2 (0.5%)", "3 (0.8%)",
      "40 (10.0%)", "10 (2.5%)", "9 (2.2%)",
      "6 (1.5%)", "1 (0.2%)",
      "2 (0.5%)", "2 (0.5%)", "1 (0.2%)",
      "1 (0.2%)", "2 (0.5%)",
      "2 (0.5%)", "1 (0.2%)", "1 (0.2%)",
      "1 (0.2%)", "1 (0.2%)",
      "30 (7.5%)", "8 (2.0%)", "8 (2.0%)",
      "1 (0.2%)", "1 (0.2%)",
      "2 (0.5%)", "1 (0.2%)", "2 (0.5%)",
      "2 (0.5%)", "2 (0.5%)",
      "1 (0.2%)", "1 (0.2%)", "1 (0.2%)",
      "31 (7.8%)", "10 (2.5%)",
      "9 (2.2%)", "2 (0.5%)", "2 (0.5%)",
      "1 (0.2%)", "1 (0.2%)",
      "3 (0.8%)", "2 (0.5%)", "1 (0.2%)",
      "26 (6.5%)", "10 (2.5%)",
      "6 (1.5%)", "2 (0.5%)", "2 (0.5%)",
      "2 (0.5%)", "2 (0.5%)",
      "1 (0.2%)", "1 (0.2%)", "19 (4.8%)",
      "1 (0.2%)", "4 (1.0%)",
      "1 (0.2%)", "1 (0.2%)", "1 (0.2%)",
      "2 (0.5%)", "1 (0.2%)",
      "1 (0.2%)", "1 (0.2%)", "3 (0.8%)",
      "1 (0.2%)", "1 (0.2%)",
      "1 (0.2%)", "18 (4.5%)", "5 (1.2%)",
      "3 (0.8%)", "1 (0.2%)",
      "1 (0.2%)", "2 (0.5%)", "1 (0.2%)",
      "1 (0.2%)", "1 (0.2%)",
      "2 (0.5%)", "1 (0.2%)", "9 (2.2%)",
      "3 (0.8%)", "2 (0.5%)",
      "1 (0.2%)", "1 (0.2%)", "1 (0.2%)",
      "1 (0.2%)", "8 (2.0%)",
      "2 (0.5%)", "2 (0.5%)", "1 (0.2%)",
      "2 (0.5%)", "1 (0.2%)"
    ),
    .Dim = c(106L, 5L)
  )
  testthat::expect_identical(result_matrix, expected_matrix)
})
