# Test the single variant for EGT01.

library(scda)
library(rtables)
library(dplyr)

adsl <- synthetic_cdisc_data("rcd_2022_02_28")$adsl
adeg <- synthetic_cdisc_data("rcd_2022_02_28")$adeg

testthat::test_that("EGT01 default variant is produced correctly", {
  adeg_f <- adeg %>%
    dplyr::filter(
      PARAM == "Heart Rate" &
        AVISIT != "SCREENING"
    )

  l <- basic_table() %>%
    split_cols_by("ARM") %>%
    split_rows_by("AVISIT", split_fun = drop_split_levels) %>%
    split_cols_by_multivar(
      vars = c("AVAL", "CHG"),
      varlabels = c("Analysis Value", "Absolute Change from Baseline")
    ) %>%
    summarize_colvars()

  result <- build_table(l, adeg_f)

  result_matrix <- to_string_matrix(result)
  expected_matrix <- structure(
    c(
      "", "", "BASELINE", "n", "Mean (SD)", "Median", "Min - Max",
      "WEEK 1 DAY 8", "n", "Mean (SD)", "Median", "Min - Max", "WEEK 2 DAY 15",
      "n", "Mean (SD)", "Median", "Min - Max", "WEEK 3 DAY 22", "n",
      "Mean (SD)", "Median", "Min - Max", "WEEK 4 DAY 29", "n", "Mean (SD)",
      "Median", "Min - Max", "WEEK 5 DAY 36", "n", "Mean (SD)", "Median",
      "Min - Max", "POST-BASELINE MINIMUM", "n", "Mean (SD)", "Median",
      "Min - Max", "POST-BASELINE MAXIMUM", "n", "Mean (SD)", "Median",
      "Min - Max", "A: Drug X", "Analysis Value", "", "134", "71.4 (17.9)",
      "72.7", "9.1 - 106.9", "", "134", "70.2 (20.3)", "70.7", "8.5 - 127.5",
      "", "134", "70.3 (19.6)", "70.9", "17.1 - 116.3", "", "134",
      "68.3 (20.2)", "68.8", "13.3 - 131.7", "", "134", "70.1 (18.4)",
      "69.3", "22.3 - 116.5", "", "134", "66.4 (19.7)", "65.4", "23.9 - 110.4",
      "", "134", "46.2 (12.2)", "47.3", "8.5 - 85.6", "", "134", "91.7 (13.9)",
      "90.0", "54.0 - 131.7", "A: Drug X", "Absolute Change from Baseline",
      "", "0", "NA (NA)", "NA", "NA - NA", "", "134", "-1.3 (26.0)",
      "-2.2", "-51.0 - 89.2", "", "134", "-1.1 (26.3)", "-1.1", "-85.0 - 67.5",
      "", "134", "-3.2 (28.7)", "-2.2", "-81.2 - 72.6", "", "134",
      "-1.4 (26.6)", "-4.5", "-58.1 - 77.3", "", "134", "-5.0 (27.1)",
      "-6.8", "-73.3 - 57.2", "", "134", "-25.2 (23.2)", "-26.1", "-85.0 - 45.9",
      "", "134", "20.2 (22.8)", "16.6", "-31.1 - 89.2", "B: Placebo",
      "Analysis Value", "", "134", "69.8 (20.7)", "73.4", "13.5 - 115.5",
      "", "134", "69.4 (20.8)", "70.5", "16.9 - 129.1", "", "134",
      "71.1 (20.6)", "72.5", "9.2 - 120.5", "", "134", "68.9 (20.6)",
      "67.8", "24.0 - 130.4", "", "134", "71.6 (20.3)", "72.2", "17.5 - 129.1",
      "", "134", "71.3 (18.9)", "70.9", "25.9 - 125.7", "", "134",
      "47.1 (14.1)", "47.3", "9.2 - 83.0", "", "134", "93.5 (14.4)",
      "91.0", "63.6 - 130.4", "B: Placebo", "Absolute Change from Baseline",
      "", "0", "NA (NA)", "NA", "NA - NA", "", "134", "-0.4 (29.7)",
      "-0.5", "-68.2 - 88.4", "", "134", "1.3 (31.4)", "-0.3", "-73.1 - 81.4",
      "", "134", "-0.9 (30.1)", "1.2", "-73.0 - 103.3", "", "134", "1.8 (30.3)",
      "-0.9", "-64.3 - 85.3", "", "134", "1.4 (27.1)", "0.6", "-71.2 - 67.4",
      "", "134", "-22.7 (26.0)", "-24.3", "-73.1 - 47.0", "", "134", "23.6 (26.5)",
      "22.9", "-33.1 - 103.3", "C: Combination", "Analysis Value",
      "", "132", "69.3 (20.9)", "72.0", "11.6 - 115.5", "", "132", "68.7 (18.1)",
      "68.6", "16.9 - 115.6", "", "132", "69.2 (18.1)", "69.3", "29.6 - 120.5",
      "", "132", "70.9 (20.3)", "70.1", "20.9 - 116.8", "", "132",
      "71.0 (20.6)", "70.5", "10.4 - 117.3", "", "132", "71.3 (18.6)",
      "73.3", "23.9 - 117.2", "", "132", "47.4 (12.6)", "48.2", "10.4 - 80.4",
      "", "132", "92.6 (12.1)", "93.4", "65.7 - 120.5", "C: Combination",
      "Absolute Change from Baseline", "", "0", "NA (NA)", "NA", "NA - NA",
      "", "132", "-0.7 (27.8)", "-0.8", "-68.2 - 67.2", "", "132",
      "-0.1 (28.6)", "-1.5", "-67.7 - 66.3", "", "132", "1.5 (27.3)",
      "0.1", "-64.5 - 72.5", "", "132", "1.7 (29.6)", "3.8", "-65.9 - 105.7",
      "", "132", "1.9 (29.6)", "1.7", "-58.2 - 68.9", "", "132", "-21.9 (24.7)",
      "-24.9", "-68.2 - 45.3", "", "132", "23.3 (23.1)", "22.1", "-28.5 - 105.7"
    ),
    .Dim = c(42L, 7L)
  )

  testthat::expect_identical(result_matrix, expected_matrix)
})
