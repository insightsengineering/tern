---
title: "Design: Duration of Response Table Table (DORT01)"
author: "Maximo Carreras"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Design of DORT01}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

## Configuration

```{r setup}
library(rtables)
library(tern)

packageVersion("tern")
packageVersion("rtables")

set.seed(1, kind = "Mersenne-Twister")

```

# Variant 1

Note that the first row of the mockup table in the "GDS_Standard_TLG_Specs_Tables_2.doc" document, displaying the number of responders in each treatment arm, does not appear in the table below. Also, the total number of patients in each arm in the mock-up table corresponds to the total number of patients in the ITT population; that is, responder and non-responder patients. In the table below, we only work with responder patients.

```{r variant1, results = "asis", eval = TRUE}

library(dplyr)
library(random.cdisc.data)
library(assertthat)

adsl <- radsl(cached = TRUE)
adtte <- radtte(cached = TRUE)

adtte_f <- adtte %>%
  filter(PARAMCD == "CRSD" & BMEASIFL == "Y") %>%
  dplyr::mutate(
    AVAL = day2month(AVAL),
    is_event = CNSR == 0,
    is_not_event = CNSR == 1,
    EVNT1 = factor(
      case_when(
        is_event == TRUE ~ "Responders with subsequent event (%)",
        is_event == FALSE ~ "Responders without subsequent event (%)"
      )
    ),
    EVNTDESC = factor(EVNTDESC)
  )

result <- basic_table() %>%
  split_cols_by(var = "ARM", ref_group = "A: Drug X") %>%
  add_colcounts() %>%
  split_rows_by("EVNT1", split_fun = keep_split_levels("Responders with subsequent event (%)")) %>%
  summarize_row_groups() %>%
  summarize_vars(
    vars = "EVNTDESC",
    .stats = "count"
  ) %>%
  summarize_vars(
    "is_not_event",
    .stats = "count_fraction",
    .labels = c(count_fraction = "Responders without subsequent event (%)"),
    nested = FALSE,
    show_labels = "hidden"
  ) %>%
  surv_time(
    vars = "AVAL",
    var_labels = "Duration of response (Months)",
    is_event = "is_event"
  ) %>%
  coxph_pairwise(
    vars = "AVAL",
    is_event = "is_event",
    var_labels = c("Unstratified Analysis"),
    control = control_coxph(pval_method = "log-rank")
  ) %>%
  surv_timepoint(
    vars = "AVAL",
    var_labels = "6 Months duration",
    is_event = "is_event",
    control = control_surv_timepoint(time_point = 6)
  ) %>%
  surv_timepoint(
    vars = "AVAL",
    var_labels = "12 Months duration",
    is_event = "is_event",
    control = control_surv_timepoint(time_point = 12)
  ) %>%
  build_table(adtte_f)

result

```

# Variant 2

Remove sections of the table concerning 6 and 12 months duration.

```{r variant 2, results = "asis", eval = TRUE}

library(dplyr)
library(random.cdisc.data)
library(assertthat)

adsl <- radsl(cached = TRUE)
adtte <- radtte(cached = TRUE)

adtte_f <- adtte %>%
  filter(PARAMCD == "CRSD" & BMEASIFL == "Y") %>%
  dplyr::mutate(
    AVAL = day2month(AVAL),
    is_event = CNSR == 0,
    is_not_event = CNSR == 1,
    EVNT1 = factor(
      case_when(
        is_event == TRUE ~ "Responders with subsequent event (%)",
        is_event == FALSE ~ "Responders without subsequent event (%)"
      )
    ),
    EVNTDESC = factor(EVNTDESC)
  )

result <- basic_table() %>%
  split_cols_by(var = "ARM", ref_group = "A: Drug X") %>%
  add_colcounts() %>%
  split_rows_by("EVNT1", split_fun = keep_split_levels("Responders with subsequent event (%)")) %>%
  summarize_row_groups() %>%
  summarize_vars(
    vars = "EVNTDESC",
    .stats = "count"
  ) %>%
  summarize_vars(
    "is_not_event",
    .stats = "count_fraction",
    .labels = c(count_fraction = "Responders without subsequent event (%)"),
    nested = FALSE,
    show_labels = "hidden"
  ) %>%
  surv_time(
    vars = "AVAL",
    var_labels = "Duration of response (Months)",
    is_event = "is_event"
  ) %>%
  coxph_pairwise(
    vars = "AVAL",
    is_event = "is_event",
    var_labels = c("Unstratified Analysis"),
    control = control_coxph(pval_method = "log-rank")
  ) %>%
  build_table(adtte_f)

result

```

# Variant 3

Variant 3 is the same as variant 1 but changing the confidence level on all confidence intervals to 90%.

```{r variant3, results = "asis", eval = TRUE}

library(dplyr)
library(random.cdisc.data)
library(assertthat)

adsl <- radsl(cached = TRUE)
adtte <- radtte(cached = TRUE)

adtte_f <- adtte %>%
  filter(PARAMCD == "CRSD" & BMEASIFL == "Y") %>%
  dplyr::mutate(
    AVAL = day2month(AVAL),
    is_event = CNSR == 0,
    is_not_event = CNSR == 1,
    EVNT1 = factor(
      case_when(
        is_event == TRUE ~ "Responders with subsequent event (%)",
        is_event == FALSE ~ "Responders without subsequent event (%)"
      )
    ),
    EVNTDESC = factor(EVNTDESC)
  )

result <- basic_table() %>%
  split_cols_by(var = "ARM", ref_group = "A: Drug X") %>%
  add_colcounts() %>%
  split_rows_by("EVNT1", split_fun = keep_split_levels("Responders with subsequent event (%)")) %>%
  summarize_row_groups() %>%
  summarize_vars(
    vars = "EVNTDESC",
    .stats = "count"
  ) %>%
  summarize_vars(
    "is_not_event",
    .stats = "count_fraction",
    .labels = c(count_fraction = "Responders without subsequent event (%)"),
    nested = FALSE,
    show_labels = "hidden"
  ) %>%
  surv_time(
    vars = "AVAL",
    var_labels = "Duration of response (Months)",
    is_event = "is_event"
  ) %>%
  coxph_pairwise(
    vars = "AVAL",
    is_event = "is_event",
    var_labels = c("Unstratified Analysis"),
    control = control_coxph(pval_method = "log-rank", conf_level = 0.90)
  ) %>%
  surv_timepoint(
    vars = "AVAL",
    var_labels = "6 Months duration",
    is_event = "is_event",
    control = control_surv_timepoint(time_point = 6, conf_level = 0.90)
  ) %>%
  surv_timepoint(
    vars = "AVAL",
    var_labels = "12 Months duration",
    is_event = "is_event",
    control = control_surv_timepoint(time_point = 12, conf_level = 0.90)
  ) %>%
  build_table(adtte_f)

result

```
