---
title: "Design: Concomitant Medication Table (CMT01)"
author: "Maximo Carreras"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Design of CMT01}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

## Configuration

```{r setup}
library(rtables)
library(tern)

packageVersion("tern")
packageVersion("rtables")

set.seed(1, kind = "Mersenne-Twister")

library(dplyr)
library(random.cdisc.data)
library(assertthat)

```

## Set up data
I need to add the "All Patients" count in "n_per_arm" to avoid wrong computation of percentages
with "build_table(adcm, col_counts = n_per_arm)".


```{r data}

adsl <- radsl(cached = TRUE)

n_per_arm <- table(adsl$ARM)

n_per_arm[4] <- sum(n_per_arm)
names(n_per_arm)[4] <- "All Patients"

adcm <- radcm(cached = TRUE)

adcm_c <- adcm %>% filter(ATIREL == "CONCOMITANT")
adcm_p <- adcm %>% filter(ATIREL == "PRIOR")

```


## Variant 1: Concomitant medications
This variant sorts by medication class alphabetically and within medication class by decreasing total number of patients with the specific medication. The "split_rows_by" function already sorts by medication class alphabetically. Use the "sort_at_path" function to sort by decreasing total number of patients with the specific medication. It is unclear whether the function "score_occurrence" used as argument to the function "sort_at_path" would sort the medications classes in alphabetical order. We would need to check this.

```{r variant 1}
result <- basic_table() %>%
  split_cols_by(var = "ARM", split_fun = add_overall_level("All Patients", first = FALSE)) %>%
  add_colcounts() %>%
  summarize_num_patients(
    var = "USUBJID",
    .stats = c("unique", "nonunique"),
    .labels = c("Total number of patients with at least one treatment (%)", "Total number of treatments")
  ) %>%
  split_rows_by("CMCLAS", split_fun = drop_split_levels, child_labels = "visible", nested = FALSE) %>%
  summarize_num_patients(
    var = "USUBJID",
    .labels = c("Total number of patients with at least one treatment (%)", "Total number of treatments")
  ) %>%
  count_occurrences(var = "CMDECOD") %>%
  build_table(adcm_c, col_counts = n_per_arm) %>%
  prune_table() %>%
  sort_at_path(path =  c("CMCLAS", "*", "CMDECOD"), scorefun = score_occurrences)

 result

```



## Variant 2: Concomitant Medications showing medications prior to the start of the study
Filter for medications used at any time up to the start of study.
Sort by medication class alphabetically and within medication class by decreasing total number of patients with the specific medication. The "split_rows_by" function already sorts by medication class alphabetically. Use the "sort_at_path" function to sort by decreasing total number of patients with the specific medication. It is unclear whether the function "score_occurrence" used as argument to the function "sort_at_path" would sort the medications classes in alphabetical order. We would need to check this.

```{r variant 2}

result <- basic_table() %>%
  split_cols_by(var = "ARM", split_fun = add_overall_level("All Patients", first = FALSE)) %>%
  add_colcounts() %>%
  summarize_num_patients(
    var = "USUBJID",
    .stats = c("unique", "nonunique"),
    .labels = c("Total number of patients with at least one treatment (%)", "Total number of treatments")
  ) %>%
  split_rows_by("CMCLAS", split_fun = drop_split_levels, child_labels = "visible", nested = FALSE) %>%
  summarize_num_patients(
    var = "USUBJID",
    .labels = c("Total number of patients with at least one treatment (%)", "Total number of treatments")
  ) %>%
  count_occurrences(var = "CMDECOD") %>%
  build_table(adcm_p, col_counts = n_per_arm) %>%
  prune_table() %>%
  sort_at_path(path =  c("CMCLAS", "*", "CMDECOD"), scorefun = score_occurrences)

 result

```


## Variant 3: Remove "Total number of treatments" row for each class

Variant 3 is similar to variant 1 but removing the "Total number of treatments" row for each treatment class.

```{r variant 3}
result <- basic_table() %>%
  split_cols_by(var = "ARM", split_fun = add_overall_level("All Patients", first = FALSE)) %>%
  add_colcounts() %>%
  summarize_num_patients(
    var = "USUBJID",
    .stats = c("unique", "nonunique"),
    .labels = c("Total number of patients with at least one treatment (%)", "Total number of treatments")
  ) %>%
  split_rows_by("CMCLAS", split_fun = drop_split_levels, child_labels = "visible", nested = FALSE) %>%
  summarize_num_patients(
    var = "USUBJID",
    .labels = c("Total number of patients with at least one treatment (%)"),
    .stats = "unique"
  ) %>%
  count_occurrences(var = "CMDECOD") %>%
  build_table(adcm_c, col_counts = n_per_arm) %>%
  prune_table() %>%
  sort_at_path(path =  c("CMCLAS", "*", "CMDECOD"), scorefun = score_occurrences)

 result

```



## Variant 4: Sort data by total column frequency from most to least frequently reported medication class
Variant 4 is similar to variant 1 but sorting the data by total column frequency from most to least frequently reported medication class.  Within a medication class, sort by decreasing total number of patients with the specific medication.

```{r variant 4}

result <- basic_table() %>%
  split_cols_by(var = "ARM", split_fun = add_overall_level("All Patients", first = FALSE)) %>%
  add_colcounts() %>%
  summarize_num_patients(
    var = "USUBJID",
    .stats = c("unique", "nonunique"),
    .labels = c("Total number of patients with at least one treatment (%)", "Total number of treatments")
  ) %>%
  split_rows_by("CMCLAS", split_fun = drop_split_levels, child_labels = "visible", nested = FALSE) %>%
  summarize_num_patients(
    var = "USUBJID",
    .labels = c("Total number of patients with at least one treatment (%)", "Total number of treatments")
  ) %>%
  count_occurrences(var = "CMDECOD") %>%
  build_table(adcm_c, col_counts = n_per_arm) %>%
  prune_table() %>%
  sort_at_path(path = c("CMCLAS", "*", "CMDECOD"), scorefun = score_occurrences, decreasing = TRUE) %>%
  sort_at_path(path = c("CMCLAS"), scorefun = cont_n_onecol(4), decreasing = TRUE)

result

```
