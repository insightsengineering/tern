---
title: "Design for helper function to create layout map"
author: "Rosemary Li"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    theme: journal
    highlight: zenburn
vignette: >
  %\VignetteIndexEntry{Design of LBT04}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

Configuration
=============

```{r setup}
library(rtables)
library(tern)
library(dplyr)
library(assertthat)

packageVersion("tern")
packageVersion("rtables")
```

Introduction
=============

When templates like LBT04, VST02, EGT02, LBT15 et al were refactored using `trim_levels_to_map`, how to define the map
correctly is critical. Different templates have different scenarios to create the map. For example
- VST02/ECGT02 have both directions
- LBT04 follow the rule that [at least one observation with ANRLO > 0 for low direction and at least one observation with ANRHI is not missing for high direction](https://pages.github.roche.com/MDIS/stream_doc/2_11/um/macro_ref/MACRO_str_tlg_proc_createanrindref.html).
- LBT15 map is created from metadata, a similar rule can be found at https://pages.github.roche.com/MDIS/stream_doc/um/techdoc/macro_ref/MACRO_str_tlg_proc_addgradedirs.html?highlight=addncigradedirs

Design
=============

Maybe the function can get different `method` so that map for different templates can be created accordingly.

```{r}
h_map_with_count_abnormal <- function(
  df,
  split_rows_varibles,
  anl_variable,
  abnormal = list(low = c("LOW", "LOW LOW"), high = c("HIGH", "HIGH HIGH")),
  method = c("default", "both", "lbt04")
) {
  assert_that(
    is.string(anl_variable),
    is_df_with_variables(df, list(val = split_rows_varibles, anl = anl_variable)),
    is_character_list(abnormal, min_length = 2, max_length = 2)
  )
  method <- match.arg(method)
  
  # default method will only have what is observed in the df, and records with all normals will be excluded to avoind error in rtable building.
  if(method == "default") {
    df_abnormal <- subset(df, df[[anl_variable]] %in% unlist(abnormal))
    map <- unique(df_abnormal[c(split_rows_varibles, anl_variable)])
    map_normal <- unique(map[, split_rows_varibles])
    map_normal[[anl_variable]] = "NORMAL"
    map <- rbind(map, map_normal)
    map <- data.frame(lapply(map, as.character), stringsAsFactors = FALSE)
  }
  
  map
}
```

