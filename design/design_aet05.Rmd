---
title: "Design: AE Rate Adjusted for Patient-Years at Risk (AET05)"
author: "Godwin Yung"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Design of AET05}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

## Configuration

```{r setup}
library(rtables)
library(tern)
library(assertthat)
library(dplyr)
library(checkmate)

source("../R/utils.R")
packageVersion("tern")
packageVersion("rtables")
```
```{r data, eval = TRUE}
library(random.cdisc.data)

adsl <- radsl(cached = TRUE)
anl <- radaette(cached = TRUE) %>%
  dplyr::filter(PARAM == "Time to first occurrence of any adverse event") %>%
  mutate(is_event = CNSR == 0)

df <- data.frame(
  USUBJID = as.character(seq(6)),
  CNSR = c(0, 1, 1, 0, 0, 0),
  AVAL = c(10.1, 20.4, 15.3, 20.8, 18.7, 23.4),
  ARM = factor(c("A", "A", "A", "B", "B", "B"))
) %>%
  mutate(is_event = CNSR == 0)
```

## Design Summary

- [x] Statistics function for total patient years, number of adverse events, and AE rate
- [x] Helper function for various types of confidence interval
- [x] Layout analyze function
- [x] Two variants from AET05
- [ ] Two variants from AET05_ALL

## Statistics Functions
```{r s_fun}
s_adjusted_rate <- function(df,
                            .var,
                            is_event,
                            control = control_adjusted_rate()) {
  assertthat::assert_that(
    is_df_with_variables(df, list(tte = .var, is_event = is_event)),
    assertthat::is.string(.var)
  )

  checkmate::assert_numeric(df[[.var]], min.len = 1, any.missing = FALSE)
  checkmate::assert_logical(df[[is_event]], min.len = 1, any.missing = FALSE)

  time_unit <- control$time_unit
  conf_level <- control$conf_level
  person_years <- sum(df[[.var]], na.rm = T)
  num_events <- sum(df[[is_event]], na.rm = T)
  rate <- num_events / person_years * time_unit
  rate_ci <- h_rate_ci(
    person_years,
    num_events,
    control
  )

  list(
    person_years = formatters::with_label(person_years, "Total patient-years at risk"),
    num_events = formatters::with_label(num_events, "Number of adverse events observed"),
    rate = formatters::with_label(rate, paste("AE rate per", time_unit, "patient-years")),
    rate_ci = formatters::with_label(rate_ci, f_conf_level(conf_level))
  )
}
```

## Helper Functions
```{r help_fun}
h_rate_ci <- function(person_years,
                      num_events,
                      control = control_adjusted_rate()) {
  checkmate::is_number(person_years)
  checkmate::is_number(num_events)

  conf_level <- control$conf_level
  conf_type <- control$conf_type
  time_unit <- control$time_unit
  alpha <- 1 - conf_level
  q_norm <- qnorm(1 - alpha / 2)

  if (conf_type == "normal") {
    rate_est <- num_events / person_years
    rate_se <- sqrt(rate_est / person_years)
    lcl <- rate_est - q_norm * rate_se
    ucl <- rate_est + q_norm * rate_se
  } else if (conf_type == "normal for log transform") {
    rate_est <- num_events / person_years
    rate_se <- sqrt(rate_est / person_years)
    lrate_est <- log(rate_est)
    lrate_se <- rate_se / rate_est
    lcl <- exp(lrate_est - q_norm * lrate_se)
    ucl <- exp(lrate_est + q_norm * lrate_se)
  } else if (conf_type == "exact") {
    lcl <- qchisq(p = (alpha) / 2, df = 2 * num_events) / (2 * person_years)
    ucl <- qchisq(p = 1 - (alpha) / 2, df = 2 * num_events + 2) / (2 * person_years)
  } else if (conf_type == "byar") {
    seg_1 <- num_events + 0.5
    seg_2 <- 1 - 1 / (9 * (num_events + 0.5))
    seg_3 <- q_norm * sqrt(1 / (num_events + 0.5)) / 3
    lcl <- seg_1 * ((seg_2 - seg_3)^3) / person_years
    ucl <- seg_1 * ((seg_2 + seg_3)^3) / person_years
  }
  c(lcl, ucl) * time_unit
}

control_adjusted_rate <- function(time_unit = 100,
                                  conf_level = 0.95,
                                  conf_type = c("normal", "normal for log transform", "exact", "byar")) {
  conf_type <- match.arg(conf_type)
  checkamte::assert_number(time_unit)
  assertthat::assert_that(
    is_proportion(conf_level)
  )
  list(conf_level = conf_level, conf_type = conf_type, time_unit = time_unit)
}
```

## Layout Functions

```{r lyt_fun}
adjusted_rate <- function(lyt,
                          vars,
                          .stats = c("person_years", "num_events", "rate", "rate_ci"),
                          ...) {
  a_adjusted_rate <- tern:::format_wrap_df(
    s_adjusted_rate,
    indent_mods = c(
      "person_years" = 0L,
      "num_events" = 0L,
      "rate" = 0L,
      "rate_ci" = 0L
    ),
    formats = c(
      "person_years" = "xx.x",
      "num_events" = "xx",
      "rate" = "xx.xx",
      "rate_ci" = "(xx.xx, xx.xx)"
    )
  )

  analyze(
    lyt,
    vars,
    show_labels = "hidden",
    afun = a_adjusted_rate,
    extra_args = c(list(.stats = .stats), list(...))
  )
}
```

## Toy example
```{r toy}
n_per_arm <- table(df$ARM)

s_adjusted_rate(df, .var = "AVAL", is_event = "is_event")

basic_table() %>%
  split_cols_by("ARM") %>%
  add_colcounts() %>%
  adjusted_rate(vars = "AVAL", is_event = "is_event") %>%
  build_table(df, col_counts = n_per_arm)
```

## Variant 1: Adverse Event Rate Adjusted for Patient-Years at Risk - First Occurrence
```{r var1}
n_per_arm <- table(adsl$ARM)

basic_table() %>%
  split_cols_by("ARM") %>%
  add_colcounts() %>%
  adjusted_rate(vars = "AVAL", is_event = "is_event") %>%
  build_table(anl, col_counts = n_per_arm)
```

## Variant 2: Adverse Event Rate Adjusted for Patient-Years at Risk - First Occurrence (setting type of confidence interval)
```{r var2}
n_per_arm <- table(adsl$ARM)

basic_table() %>%
  split_cols_by("ARM") %>%
  add_colcounts() %>%
  adjusted_rate(
    vars = "AVAL",
    is_event = "is_event",
    control = control_adjusted_rate(time_unit = 100, conf_level = 0.95, conf_type = "exact")
  ) %>%
  build_table(anl, col_counts = n_per_arm)
```
