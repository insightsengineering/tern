---
title: "Design for RATET01: Event Rate Summary for Recurrent Events"
subtitle: "Poisson and Negative Binomial Regression for Count Endpoint"
author: "Brandon Butcher"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Design for RATET01: Event Rate Summary for Recurrent Events}
  %\VignetteEngine{knitr::rmarkdown}
editor_options:
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

## Configuration

```{r setup}
library(rtables)
library(tern)
library(dplyr)
library(tidyr)
library(stringr)
packageVersion("tern")
packageVersion("rtables")
```

## Implementation of RATET01

RATET01: Tables, Listings, and Graphs Specification for Respiratory (Version: Dec 2021)

-   Adjusted rate can be estimated from either Quasi-Poisson or Negative Binomial

### Design

[**Helper functions**]{.underline}:

```{r}
h_glm_poisson <- function(.var,
                          .df_row,
                          variables,
                          weights) {
  arm <- variables$arm

  formula <- as.formula(paste0(
    .var, " ~ ", " + ", arm
  ))

  if (!is.null(variables$covariates)) {
    covariates <- variables$covariates
    forumla_new <- as.formula(paste("~ . +", paste(covariates, collapse = " + ")))
    formula <- update(formula, forumla_new)
  }

  if (!is.null(variables$offset)) {
    offset <- variables$offset
    forumla_new <- as.formula(paste("~ . +", paste("offset(", offset, ")")))
    formula <- update(formula, forumla_new)
  }

  glm_fit <- glm(
    formula = formula,
    data = .df_row,
    family = poisson(link = "log")
  )

  emmeans_fit <- emmeans::emmeans(
    glm_fit,
    specs = arm,
    data = .df_row,
    type = "response",
    offset = 0,
    weights = weights
  )

  list(
    glm_fit = glm_fit,
    emmeans_fit = emmeans_fit
  )
}
```

```{r}
h_glm_quasipoisson <- function(.var,
                               .df_row,
                               variables,
                               weights) {
  arm <- variables$arm

  formula <- as.formula(paste0(
    .var, " ~ ", " + ", arm
  ))

  if (!is.null(variables$covariates)) {
    covariates <- variables$covariates
    forumla_new <- as.formula(paste("~ . +", paste(covariates, collapse = " + ")))
    formula <- update(formula, forumla_new)
  }

  if (!is.null(variables$offset)) {
    covariates <- variables$covariates
    forumla_new <- as.formula(paste("~ . +", paste("offset(", offset, ")")))
    formula <- update(formula, forumla_new)
  }

  glm_fit <- glm(
    formula = formula,
    data = .df_row,
    family = quasipoisson(link = "log")
  )

  emmeans_fit <- emmeans::emmeans(
    glm_fit,
    specs = arm,
    data = .df_row,
    type = "response",
    offset = 0,
    weights = weights
  )

  list(
    glm_fit = glm_fit,
    emmeans_fit = emmeans_fit
  )
}
```

```{r}
h_glm_negbin <- function(.var,
                         .df_row,
                         variables,
                         weights) {
  arm <- variables$arm

  formula <- as.formula(paste0(
    .var, " ~ ", " + ", arm
  ))

  if (!is.null(variables$covariates)) {
    covariates <- variables$covariates
    forumla_new <- as.formula(paste("~ . +", paste(covariates, collapse = " + ")))
    formula <- update(formula, forumla_new)
  }

  if (!is.null(variables$offset)) {
    covariates <- variables$covariates
    forumla_new <- as.formula(paste("~ . +", paste("offset(", offset, ")")))
    formula <- update(formula, forumla_new)
  }

  glm_fit <- MASS::glm.nb(
    formula = formula,
    data = .df_row,
    link = "log"
  )

  emmeans_fit <- emmeans::emmeans(
    glm_fit,
    specs = arm,
    data = .df_row,
    type = "response",
    offset = 0,
    weights = weights
  )

  list(
    glm_fit = glm_fit,
    emmeans_fit = emmeans_fit
  )
}
```

```{r}
h_glm_count <- function(.var,
                        .df_row,
                        variables,
                        distribution,
                        weights) {
  switch(distribution,
    poisson = h_glm_poisson(.var, .df_row, variables, weights),
    quasipoisson = h_glm_quasipoisson(.var, .df_row, variables, weights),
    negbin = h_glm_negbin(.var, .df_row, variables, weights)
  )
}
```

```{r}
h_ppmeans <- function(obj, .df_row, arm, conf_level) {
  alpha <- 1 - conf_level
  p <- 1 - alpha / 2

  arm_levels <- levels(.df_row[[arm]])

  out <- lapply(arm_levels, function(lev) {
    lev <- arm_levels[[1]]

    temp <- .df_row
    temp[[arm]] <- factor(lev, levels = arm_levels)

    mf <- model.frame(obj$formula, data = temp)
    X <- model.matrix(obj$formula, data = mf)

    rate <- predict(obj, newdata = temp, type = "response")
    rate_hat <- mean(rate)

    ## Delta Method for log link function
    zz <- colMeans(rate * X)
    se <- sqrt(as.numeric(t(zz) %*% vcov(obj) %*% zz))
    rate_lwr <- rate_hat * exp(-qnorm(p) * se / rate_hat)
    rate_upr <- rate_hat * exp(qnorm(p) * se / rate_hat)

    c(rate_hat, rate_lwr, rate_upr)
  })

  names(out) <- arm_levels
  out <- do.call(rbind, out)
  if ("negbin" %in% class(obj)) {
    colnames(out) <- c("response", "asymp.LCL", "asymp.UCL")
  } else {
    colnames(out) <- c("rate", "asymp.LCL", "asymp.UCL")
  }
  out <- as.data.frame(out)
  out[[arm]] <- rownames(out)
  out
}
```

[**Statistics function**]{.underline}:

```{r}
s_glm_count <- function(df,
                        .var,
                        .df_row,
                        variables,
                        .ref_group,
                        .in_ref_col,
                        distribution,
                        conf_level,
                        rate_mean_method,
                        weights,
                        scale = 1) {
  arm <- variables$arm

  y <- df[[.var]]
  smry_level <- as.character(unique(df[[arm]]))

  results <- h_glm_count(
    .var = .var,
    .df_row = .df_row,
    variables = variables,
    distribution = distribution,
    weights
  )

  if (rate_mean_method == "emmeans") {
    emmeans_smry <- summary(results$emmeans_fit, level = conf_level)
  } else if (rate_mean_method == "ppmeans") {
    emmeans_smry <- h_ppmeans(results$glm_fit, .df_row, arm, conf_level)
  }

  emmeans_smry_level <- emmeans_smry[emmeans_smry[[arm]] == smry_level, ]

  if (.in_ref_col) {
    list(
      n = length(y[!is.na(y)]),
      rate = with_label(
        ifelse(distribution == "negbin", emmeans_smry_level$response * scale, emmeans_smry_level$rate),
        "Adjusted Rate"
      ),
      rate_ci = with_label(
        c(emmeans_smry_level$asymp.LCL * scale, emmeans_smry_level$asymp.UCL * scale),
        tern:::f_conf_level(conf_level)
      ),
      rate_ratio = with_label(character(), "Adjusted Rate Ratio"),
      rate_ratio_ci = with_label(character(), tern:::f_conf_level(conf_level)),
      pval = with_label(character(), "p-value")
    )
  } else {
    emmeans_contrasts <- emmeans::contrast(
      results$emmeans_fit,
      method = "trt.vs.ctrl",
      ref = 1
    )

    contrasts_smry <- summary(
      emmeans_contrasts,
      infer = TRUE,
      adjust = "none"
    )

    smry_contrasts_level <- contrasts_smry[grepl(smry_level, contrasts_smry$contrast), ]

    list(
      n = length(y[!is.na(y)]),
      rate = with_label(
        ifelse(distribution == "negbin", emmeans_smry_level$response * scale, emmeans_smry_level$rate),
        "Adjusted Rate"
      ),
      rate_ci = with_label(
        c(emmeans_smry_level$asymp.LCL * scale, emmeans_smry_level$asymp.UCL * scale),
        tern:::f_conf_level(conf_level)
      ),
      rate_ratio = with_label(smry_contrasts_level$ratio, "Adjusted Rate Ratio"),
      rate_ratio_ci = with_label(
        c(smry_contrasts_level$asymp.LCL, smry_contrasts_level$asymp.UCL),
        tern:::f_conf_level(conf_level)
      ),
      pval = with_label(smry_contrasts_level$p.value, "p-value")
    )
  }
}
```

[**Analysis function**]{.underline}:

```{r}
a_glm_count <- make_afun(
  s_glm_count,
  .indent_mods = c(
    "n" = 0L,
    "rate" = 0L,
    "rate_ci" = 1L,
    "rate_ratio" = 0L,
    "rate_ratio_ci" = 1L,
    "pval" = 1L
  ),
  .formats = c(
    "n" = "xx",
    "rate" = "xx.xxxx",
    "rate_ci" = "(xx.xxxx, xx.xxxx)",
    "rate_ratio" = "xx.xxxx",
    "rate_ratio_ci" = "(xx.xxxx, xx.xxxx)",
    "pval" = "x.xxxx | (<0.0001)"
  ),
  .null_ref_cells = FALSE
)
```

[**Summarize function**]{.underline}:

```{r}
summarize_glm_count <- function(lyt,
                                vars,
                                var_labels,
                                ...,
                                show_labels = "visible",
                                table_names = vars,
                                .stats = NULL,
                                .formats = NULL,
                                .labels = NULL,
                                .indent_mods = NULL) {
  afun <- make_afun(
    a_glm_count,
    .stats = .stats,
    .formats = .formats,
    .labels = .labels,
    .indent_mods = .indent_mods
  )

  analyze(
    lyt,
    vars,
    var_labels = var_labels,
    show_labels = show_labels,
    table_names = table_names,
    afun = afun,
    extra_args = list(...)
  )
}
```

### Example

Get example cancer dataset from Alan Agresti's website: <https://users.stat.ufl.edu/~aa/glm/data/Cancer.dat>

```{r}
cancer <- read.table("https://users.stat.ufl.edu/~aa/glm/data/Cancer.dat", header = TRUE)

set.seed(12345)
anl <- cancer %>%
  mutate(
    arm = sample(c("A", "B"), size = nrow(.), replace = TRUE),
    arm = factor(arm),
    ln_time_at_risk = log(risktime),
    count_f = factor(count, levels = sort(unique(count)))
  )

covars <- c("histology", "stage", "time")
offset <- "ln_time_at_risk"
arm <- "arm"

lyt <- basic_table() %>%
  split_cols_by(arm, ref_group = "B") %>%
  add_colcounts() %>%
  summarize_vars(
    "count_f",
    var_labels = "Number of exacerbations per patient",
    .stats = c("count_fraction")
  ) %>%
  summarize_glm_count(
    vars = "count",
    variables = list(arm = arm, offset = offset, covariates = NULL),
    conf_level = 0.95,
    distribution = "poisson",
    rate_mean_method = "emmeans",
    var_labels = "Unadjusted exacerbation rate (per year)",
    table_names = "unadj",
    .stats = "rate",
    .labels = c(rate = "Rate")
  ) %>%
  summarize_glm_count(
    vars = "count",
    variables = list(arm = arm, offset = "ln_time_at_risk", covariates = covars),
    conf_level = 0.95,
    distribution = "quasipoisson",
    rate_mean_method = "ppmeans",
    var_labels = "Adjusted (QP) exacerbation rate (per year)",
    table_names = "adj",
    .stats = c("rate", "rate_ci", "rate_ratio", "rate_ratio_ci", "pval"),
    .labels = c(rate = "Rate", rate_ratio = "Rate Ratio"),
    .indent_mods = c(0L, 1L, 0L, 1L, 1L)
  )

build_table(lyt = lyt, df = anl)
```

### To-Do

1.  How to generate dummy count data from `random.cdisc.data` or one of the `scda` packages?

2.  How to calculate total number of events and time at risk in each arm?

    -   `tern::summarize_patients_exposure_in_cols` is close but not quite what's needed

    -   Add `.stats="sum"` option to `tern::summarize_vars` would seem to do the trick

3.  Need to add following calculations to statistics function

    -   Absolute rate difference

    -   Percentage rate reduction

4.  Do not implement negative binomial regression until discrepancies with SAS can be rectified

### Re-factor?

-   Perhaps it would be better to re-factor the code so that model fitting is done separately from the table generation, similar to how Cox regression, logistic regression, and MMRM currently work.

```{r, eval = FALSE}
fit_glm_count <- function(data,
                          variables = list(response, arm, covariates, offset),
                          distribution = c("poisson", "quasipoisson", "negbin"), ...) {
  ...
}
summarize_glm_rate <- function(...) {
  ...
} ## Treatment arm rates
summarize_glm_rate_ratio <- function(...) {
  ...
} ## Rate ratio
lyt <- basic_table() %>%
  split_cols_by("TRT01P", ref_group = "PLACEBO") %>%
  add_colcounts() %>%
  summarize_vars(
    "AVALF", ## Have to first convert counts to factor
    var_labels = "Number of <Endpoint> per patient",
    .stats = c("count_fraction")
  ) %>%
  summarize_vars(
    "AVAL",
    var_labels = "Total number of <Endpoint>",
    .stats = c("sum")
  ) %>%
  summarize_vars(
    "TMATRSK",
    var_labels = "Total follow-up time at risk (years)",
    .stats = c("sum")
  ) %>%
  summarize_glm_rate() %>%
  summarize_glm_rate_ratio()
```
