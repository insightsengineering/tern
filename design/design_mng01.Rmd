title: "Design for MNG01"
author:
  - Yuliia Bahatska
  - Wojciech Wojciak
date: "`r Sys.Date()`"
output:
  html_document:
  toc: true
toc_float: true
toc_depth: 2
theme: journal
highlight: zenburn
vignette: >
  %\VignetteIndexEntry{Design of MNG01}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options:
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

## Configuration
```{r setup}
library(dplyr)
library(ggplot2)
library(tern)

```

## Data for examples
```{r data, results = "asis", eval = TRUE}

adlb <- scda::synthetic_cdisc_data("latest")$adlb

adlb <- adlb %>%
  filter(ANL01FL == "Y",
         PARAMCD == "ALT",
         AVISIT != "SCREENING") %>%
  df_explicit_na()

```

## New function to display graphs
```{r fun}

# Helper function to get the right formatting in the table.
h_format_row <- function(x, format, labels = NULL) {

  format_cell <- function(x, format, label = NULL) {
    fc <- rtables::format_rcell(x = x, format = format)
    x_label <- attr(x, "label")
    if (!is.null(label) && !is.na(label))
      names(fc) <- label
    else if (!is.null(x_label) && !is.na(x_label))
      names(fc) <- x_label
    else if (length(x) == length(fc))
      names(fc) <- names(x)
    as.data.frame(t(fc)) # cell: one row, one column data.frame
  }

  row <- dplyr::bind_cols(
    lapply(
      names(x), function(n) format_cell(x[[n]], format = format[n], label = labels[n])
    )
  )

  row
}

# New plot function.
g_lineplot <- function(df, # nolint
                       alt_counts_df = NULL,
                       variables = c(
                         x = "AVISIT",
                         y = "AVAL",
                         strata = "ARM",
                         y_lab = "PARAMCD",
                         y_unit = "AVALU"
                       ),
                       mid = "mean",
                       interval = "mean_ci",
                       whiskers = c("lwr", "upr"),
                       table = NULL,
                       sfun = tern::s_summary,
                       ...,
                       na.rm = TRUE, # nolint
                       table_format = tern::summary_formats(),
                       table_labels = tern::summary_labels(),
                       table_font_size = 3,
                       mid_type = "pl",
                       mid_point_size = 2,
                       position = position_dodge(width = 0.4),
                       legend_position = "bottom",
                       legend_title = NULL,
                       ggtheme = NULL,
                       title = "Plot of Mean and 95% Confidence Limits by Visit",
                       caption = NULL,
                       newpage = TRUE) {

  assertthat::assert_that(is.character(mid) || is.null(mid))
  assertthat::assert_that(is.character(interval) || is.null(interval))
  assertthat::assert_that(ifelse(is.character(interval), all(whiskers %in% c("lwr", "upr")), TRUE))
  assertthat::assert_that(ifelse(length(whiskers) == 1, is.character(mid), TRUE))
  assertthat::assert_that(assertthat::is.string(title) || is.null(title))
  assertthat::assert_that(
    ifelse(
      is.character(mid),
      (length(mid_type) == 1) && mid_type %in% c("pl", "p", "l"),
      TRUE
    )
  )
  assertthat::assert_that(
    is.character(variables),
    all(c("x", "y") %in% names(variables))
  )

  x <- variables[["x"]]
  y <- variables[["y"]]
  strata <- if (!is.na(variables["strata"])) variables[["strata"]] # NULL if no strata in variables
  y_lab <- if (!is.na(variables["y_lab"])) variables[["y_lab"]] # NULL if no y_lab in variables
  y_unit <- if (!is.na(variables["y_unit"])) variables[["y_unit"]] # NULL if no y_unit in variables

  ##################################################
  ## Compute required statistics.
  ##################################################
  #df_stats <- aggregate( # nolint
  #  x = df[[y]], # nolint
  #  by = df[, c(strata, x)], # nolint
  #  FUN = function(val) do.call(c, unname(sfun(val)[c(mid, interval)])) # nolint
  #) # nolint
  #assertthat::assert_that(!(any(c(strata, x) %in% colnames(df_stats$x)))) # nolint
  #df_stats <- cbind(df_stats[, c(strata, x)], df_stats$x) # nolint

  df_grp <- dplyr::group_by_at(df, c(strata, x))
  df_stats <- dplyr::summarise(
    df_grp,
    data.frame(t(do.call(c, unname(sfun(.data[[y]])[c(mid, interval)])))),
    .groups = "drop"
  )

  # add number of objects N in strata
  if (!is.null(strata) && !is.null(alt_counts_df)) {

    strata_N <- paste0(strata, "_N") # nolint

    df_N <- as.data.frame(table(alt_counts_df[[strata]], exclude = c(NA, NaN, Inf))) # nolint
    colnames(df_N) <- c(strata, "N")
    df_N[[strata_N]] <- paste0(df_N[[strata]], " (N = ", df_N$N, ")")

    assertthat::assert_that(!(strata_N %in% colnames(df_stats))) # as we join with df_N (which has column N)
    df_stats <- dplyr::full_join(x = df_stats, y = df_N[, c(strata, strata_N)], by = strata)

  } else if (!is.null(strata)) {
    strata_N <- strata # nolint
  } else {
    strata_N <- NULL # nolint
  }

  ##################################################
  ## Prepare certain plot's properties.
  ##################################################
  # y label
  if (!is.null(y_lab)) {
    y_lab <- unique(df[[y_lab]])
    stopifnot("y_lab must be in df and df[[y_lab]] must be of the same value" = length(y_lab) == 1) # nolint
  }

  if (!is.null(y_unit)) {
    y_unit <- unique(df[[y_unit]])
    stopifnot("y_unit must be in df and df[[y_unit]] must be of the same value" = length(y_unit) == 1) # nolint
    y_lab <- paste0(y_lab, " (", y_unit, ")")
  }

  # legend title
  if (is.null(legend_title) && !is.null(strata) && legend_position != "none") {
    legend_title <- attr(df[[strata]], "label")
  }

  ##################################################
  ## Build plot object.
  ##################################################
  p <- ggplot2::ggplot(
    data = df_stats,
    mapping = aes_string(
      x = x, y = mid, color = strata_N, shape = strata_N, lty = strata_N, group = strata_N
    ))

  if (!is.null(mid)) {
    # points
    if (grepl("p", mid_type, fixed = TRUE)) {
      p <- p + ggplot2::geom_point(position = position, size = mid_point_size)
    }

    # lines
    if (grepl("l", mid_type, fixed = TRUE)) {
      # for line graphs, the data points must be grouped so that it knows which points to connect.
      m <- if (is.null(strata)) ggplot2::aes(group = 1)
      p <- p + geom_line(mapping = m, position = position)
    }
  }

  # interval
  if (!is.null(interval)) {

    yminmax <- paste(interval, whiskers, sep = "_")

    p <- p +
      geom_errorbar(
        aes_string(ymin = yminmax[1], ymax = yminmax[max(1, length(whiskers))]),
        width = 0.45,
        position = position
      )

    if (length(whiskers) == 1) { # lwr or upr only; mid is then required
      #workaround as geom_errorbar does not provide single-direction whiskers
      p <- p +
        geom_linerange(
          aes_string(ymin = mid, ymax = yminmax),
          position = position,
          show.legend = FALSE
        )
    }
  }

  p <- p +
    scale_y_continuous(labels = scales::comma, expand = expansion(c(0.25, .25))) +
    labs(
      title = title,
      caption = caption,
      color = legend_title,
      lty = legend_title,
      shape = legend_title,
      x = attr(df[[x]], "label"),
      y = y_lab
    )

  if (!is.null(ggtheme)) {
    p <- p + ggtheme
  } else {
    p <- p +
      theme_bw() +
      theme(
        legend.key.width = unit(1, "cm"),
        legend.position = legend_position,
        legend.direction = ifelse(
          legend_position %in% c("top", "bottom"),
          "horizontal",
          "vertical")
      )
  }

  ##################################################
  ## Optionally, add table to the bottom of the plot.
  ##################################################
  if (!is.null(table)) {

    df_stats_table <- df_grp %>%
      dplyr::summarise(
        h_format_row(
          x = sfun(.data[[y]], ...)[table],
          format = table_format,
          labels = table_labels
        ),
        .groups = "drop"
      )

    stats_lev <- rev(setdiff(colnames(df_stats_table), c(strata, x)))

    df_stats_table <- df_stats_table %>%
      tidyr::pivot_longer(
        cols = -all_of(c(strata, x)),
        names_to = "stat",
        values_to = "value",
        names_ptypes = list(stat = factor(levels = stats_lev))
    )

    tbl <- ggplot2::ggplot(df_stats_table, aes_string(x = x, y = "stat", label = "value")) +
      geom_text(size = table_font_size) +
      theme_bw() +
      theme(
        panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 5)),
        strip.text = element_text(hjust = 0),
        strip.text.x = element_text(margin = margin(1.5, 0, 1.5, 0, "pt")),
        strip.background = element_rect(fill = "grey95", color = NA),
        legend.position = "none"
      )

    if (!is.null(strata)) {
      tbl <- tbl + facet_wrap(facets = strata, ncol = 1)
    }

    # align plot and table
    p_grob <- ggplotGrob(p)
    tbl_grob <- ggplotGrob(tbl)
    maxWidth <- grid::unit.pmax(p_grob$widths, tbl_grob$widths) # nolint
    p_grob$widths <- maxWidth
    tbl_grob$widths <- maxWidth

    if (newpage) {
      grid::grid.newpage()
    }

    p <- gridExtra::grid.arrange(p_grob, tbl_grob, ncol = 1, heights = c(3, 1))
    #p <- gridExtra::marrangeGrob(list(p_grob, tbl_grob), nrow = 2, ncol = 1, heights = c(3, 1), top = NULL) # nolint

  }

  return(p)

}

```


## Examples
```{r examples}

# Mean with CI
g_lineplot(adlb)

# Mean with CI, no stratification
g_lineplot(adlb, variables = c(x = "AVISIT", y = "AVAL", y_lab = "PARAMCD", y_unit = "AVALU"))

# Mean, upper whisker of CI
g_lineplot(adlb, whiskers = "upr", title = "Plot of Mean and Upper 95% Confidence Limit by Visit")

# Median with CI
g_lineplot(adlb, mid = "median", title = "Plot of Median and 95% Confidence Limits by Visit")

# Mean, +/- SD
g_lineplot(adlb, interval = "mean_sdi", title = "Plot of Median +/- SD by Visit")

# Mean with CI plot with stats table
g_lineplot(adlb, table = c("n", "mean", "mean_ci"))

# Mean with CI - continuous time variable, customized confidence level
g_lineplot(
  adlb, variables = c(x = "AVISITN", y = "AVAL", strata = "ARM", y_lab = "PARAMCD", y_unit = "AVALU"),
  table = c("n", "mean", "mean_ci"),
  control = control_summarize_vars(conf_level = 0.80),
  title = "Plot of Mean and 80% Confidence Limits by Visit"
)
```
