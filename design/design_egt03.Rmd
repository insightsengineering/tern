---
title: "Design: ECG Quantitative Assessment Shift Table (EGT03)"
author: "Maximo Carreras"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Design of EGT03}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

## Configuration

```{r setup}
library(rtables)
library(tern)

packageVersion("tern")
packageVersion("rtables")

library(random.cdisc.data)
```

## Shift Table of ECG Interval Data - Baseline versus Minimum Post-Baseline

### Variant 1:
We assume missing values both at baseline and post-baseline assessments.

```{r variant 1, eval = TRUE}

set.seed(123, kind = "Mersenne-Twister")

adsl <- radsl(cached = TRUE)
adeg <- radeg(cached = TRUE)
adeg_labels <- formatable::var_labels(adeg)

# Filtering
# ---------
adeg_f <- subset(
  adeg,
  PARAMCD == "HR" & # Heart Rate
    SAFFL == "Y" & # "Safety Population Flag"
    ONTRTFL == "Y" & # "On Treatment Record Flag"
    AVISIT == "POST-BASELINE MINIMUM" # "Analysis Visit"
)


# Preprocessing

# For the EGT03 template, data imputation shoud be avoided, and missing data
# explicit and accounted for, so the contingency table sum adds up to the group N.
# For illustration purpose, missing data are added to the example.
adeg_f$BNRIND <- factor(
  adeg_f$BNRIND,
  levels = c("LOW", "NORMAL", "HIGH", "Missing"),
  labels = c("LOW", "NORMAL", "HIGH", "Missing")
)
adeg_f$ANRIND <- factor(
  adeg_f$ANRIND,
  levels = c("LOW", "NORMAL", "HIGH", "Missing"),
  labels = c("LOW", "NORMAL", "HIGH", "Missing")
)

adeg_f$BNRIND[sample(1:nrow(adeg_f), size = 5)] <- "Missing"
adeg_f$ANRIND[sample(1:nrow(adeg_f), size = 5)] <- "Missing"


formatable::var_labels(adeg_f) <- adeg_labels

lyt <- basic_table() %>%
  split_cols_by("ANRIND") %>%
  split_rows_by("ARM") %>%
  add_rowcounts() %>%
  summarize_vars("BNRIND", denom = "N_row")

build_table(lyt = lyt, df = adeg_f)
```


### Variant 2:
We assume missing values only at baseline and not post-baseline assessments.

```{r variant 2, eval = TRUE}

set.seed(123, kind = "Mersenne-Twister")

adsl <- radsl(cached = TRUE)
adeg <- radeg(cached = TRUE)
adeg_labels <- formatable::var_labels(adeg)

# Filtering
# ---------
adeg_f <- subset(
  adeg,
  PARAMCD == "HR" & # Heart Rate
    SAFFL == "Y" & # "Safety Population Flag"
    ONTRTFL == "Y" & # "On Treatment Record Flag"
    AVISIT == "POST-BASELINE MINIMUM" # "Analysis Visit"
)


# Preprocessing

# For the EGT03 template, data imputation shoud be avoided, and missing data
# explicit and accounted for, so the contingency table sum adds up to the group N.
# For illustration purpose, missing data are added to the example.
adeg_f$BNRIND <- factor(
  adeg_f$BNRIND,
  levels = c("LOW", "NORMAL", "HIGH", "Missing"),
  labels = c("LOW", "NORMAL", "HIGH", "Missing")
)

adeg_f$BNRIND[sample(1:nrow(adeg_f), size = 5)] <- "Missing"

formatable::var_labels(adeg_f) <- adeg_labels

lyt <- basic_table() %>%
  split_cols_by("ANRIND") %>%
  split_rows_by("ARM") %>%
  add_rowcounts() %>%
  summarize_vars("BNRIND", denom = "N_row")

build_table(lyt = lyt, df = adeg_f)
```

### Variant 3:
We assume missing values only at post-baseline assessments and not at baseline.

```{r variant 3, eval = TRUE}

set.seed(123, kind = "Mersenne-Twister")

adsl <- radsl(cached = TRUE)
adeg <- radeg(cached = TRUE)
adeg_labels <- formatable::var_labels(adeg)

# Filtering
# ---------
adeg_f <- subset(
  adeg,
  PARAMCD == "HR" & # Heart Rate
    SAFFL == "Y" & # "Safety Population Flag"
    ONTRTFL == "Y" & # "On Treatment Record Flag"
    AVISIT == "POST-BASELINE MINIMUM" # "Analysis Visit"
)


# Preprocessing

# For the EGT03 template, data imputation shoud be avoided, and missing data
# explicit and accounted for, so the contingency table sum adds up to the group N.
# For illustration purpose, missing data are added to the example.
adeg_f$ANRIND <- factor(
  adeg_f$ANRIND,
  levels = c("LOW", "NORMAL", "HIGH", "Missing"),
  labels = c("LOW", "NORMAL", "HIGH", "Missing")
)

adeg_f$ANRIND[sample(1:nrow(adeg_f), size = 5)] <- "Missing"

formatable::var_labels(adeg_f) <- adeg_labels

lyt <- basic_table() %>%
  split_cols_by("ANRIND") %>%
  split_rows_by("ARM") %>%
  add_rowcounts() %>%
  summarize_vars("BNRIND", denom = "N_row")

build_table(lyt = lyt, df = adeg_f)
```


## Shift Table of ECG Interval Data - Baseline versus Maximum Post-Baseline

### Variant 4:
We assume missing values both at baseline and post-baseline assessments.

```{r variant 4, eval = TRUE}

set.seed(123, kind = "Mersenne-Twister")

adsl <- radsl(cached = TRUE)
adeg <- radeg(cached = TRUE)
adeg_labels <- formatable::var_labels(adeg)

# Filtering
# ---------
adeg_f <- subset(
  adeg,
  PARAMCD == "HR" & # Heart Rate
    SAFFL == "Y" & # "Safety Population Flag"
    ONTRTFL == "Y" & # "On Treatment Record Flag"
    AVISIT == "POST-BASELINE MAXIMUM" # "Analysis Visit"
)


# Preprocessing

# For the EGT03 template, data imputation shoud be avoided, and missing data
# explicit and accounted for, so the contingency table sum adds up to the group N.
# For illustration purpose, missing data are added to the example.
adeg_f$BNRIND <- factor(
  adeg_f$BNRIND,
  levels = c("LOW", "NORMAL", "HIGH", "Missing"),
  labels = c("LOW", "NORMAL", "HIGH", "Missing")
)
adeg_f$ANRIND <- factor(
  adeg_f$ANRIND,
  levels = c("LOW", "NORMAL", "HIGH", "Missing"),
  labels = c("LOW", "NORMAL", "HIGH", "Missing")
)

adeg_f$BNRIND[sample(1:nrow(adeg_f), size = 5)] <- "Missing"
adeg_f$ANRIND[sample(1:nrow(adeg_f), size = 5)] <- "Missing"


formatable::var_labels(adeg_f) <- adeg_labels

lyt <- basic_table() %>%
  split_cols_by("ANRIND") %>%
  split_rows_by("ARM") %>%
  add_rowcounts() %>%
  summarize_vars("BNRIND", denom = "N_row")

build_table(lyt = lyt, df = adeg_f)
```
