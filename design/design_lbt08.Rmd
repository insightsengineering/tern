---
title: "New Tern Function: Laboratory Events (Worsened from Baseline) by Highest Grade Post-Baseline Table (LBT08)"
author: "Rui Zhao"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Design of LBT08}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

```{r data, eval = TRUE}
library(random.cdisc.data)
library(dplyr)
adlb <- radlb(cached = TRUE)
adsl <- radsl(cached = TRUE)
adlb <- adlb %>%
  mutate(
    GRADDR = case_when(
      PARAMCD == "ALT" ~ "B",
      PARAMCD == "CRP" ~ "L",
      PARAMCD == "IGA" ~ "H"
    )
  ) %>%
  filter(SAFFL == "Y" & ONTRTFL == "Y" & GRADDR != "")
```


## Elementary function: `h_abnormal_by_worst_grade`
```{r h_data}
library(rtables)
library(assertthat)
library(tern)

# Elementary function: extract data with worst lab depending on the directionality
h_adlb_worsen <- function(adlb,
                          worst_flag_low = c("WGRLOFL" = "Y"),
                          worst_flag_high = c("WGRHIFL" = "Y"),
                          direction_var = "GRADDR") {
  assertthat::assert_that(
    assertthat::is.string(direction_var),
    is_df_with_variables(
      adlb,
      list(
        "High" = names(worst_flag_high),
        "Low" = names(worst_flag_low),
        "Col" = direction_var
      )
    ),
    all(unique(adlb[[direction_var]]) %in% c("B", "L", "H"))
  )

  # extract patients with worst post-baseline lab, either low or high or both
  worst_flag <- c(worst_flag_low, worst_flag_high)
  col_names <- names(worst_flag)
  filter_values <- worst_flag
  temp <- Map(
    function(x, y) which(adlb[[x]] == y),
    col_names,
    filter_values
  )
  position_satisfy_filters <- Reduce(union, temp)

  # select variables of interest
  adlb_f <- adlb[position_satisfy_filters, ] %>%
    select(all_of(c("USUBJID", "ARMCD", "AVISIT", "PARAMCD", "ATOXGR", "BTOXGR", names(worst_flag), direction_var)))




  # generate subsets for different directionality
  adlb_f_h <- adlb_f[adlb_f[[direction_var]] == "H", ]
  adlb_f_l <- adlb_f[adlb_f[[direction_var]] == "L", ]
  adlb_f_b <- adlb_f[adlb_f[[direction_var]] == "B", ]

  # for labs requiring both high and low, data is duplicated and will be stacked on top of each other
  adlb_f_b_h <- adlb_f_b
  adlb_f_b_l <- adlb_f_b

  # change H to High, L to Low
  adlb_f_h[[direction_var]] <- "High"
  adlb_f_l[[direction_var]] <- "Low"

  # change, B to High and Low
  adlb_f_b_h[[direction_var]] <- "High"
  adlb_f_b_l[[direction_var]] <- "Low"

  # extract data with worst lab
  adlb_out_h <- adlb_f_h[adlb_f_h[[names(worst_flag_high)]] == worst_flag_high, ]
  adlb_out_l <- adlb_f_l[adlb_f_l[[names(worst_flag_low)]] == worst_flag_low, ]
  adlb_out_b_h <- adlb_f_b_h[adlb_f_b_h[[names(worst_flag_high)]] == worst_flag_high, ]
  adlb_out_b_l <- adlb_f_b_l[adlb_f_b_l[[names(worst_flag_low)]] == worst_flag_low, ]

  # stack data
  out <- rbind(adlb_out_l, adlb_out_h, adlb_out_b_l, adlb_out_b_h)
  formatable::var_labels(out) <- formatable::var_labels(adlb_out_l)
  out
}

# Examples
adlb_f <- adlb %>% filter(USUBJID %in% c("AB12345-CHN-3-id-128", "AB12345-CHN-15-id-262"))

result <- h_adlb_worsen(
  adlb_f,
  worst_flag_low = c("WGRLOFL" = "Y"),
  worst_flag_high = c("WGRHIFL" = "Y"),
  direction_var = "GRADDR"
)

df <- h_adlb_worsen(
  adlb,
  worst_flag_low = c("WGRLOFL" = "Y"),
  worst_flag_high = c("WGRHIFL" = "Y"),
  direction_var = "GRADDR"
)
```

## Elementary function: `h_worsen_counter`
# Logics
* only keep patients with at least one non-missing post-baseline
* for grade 1-4:
 + denom: the number of patients with missing or less than the grade of interest at baseline, also post-baseline values must be in the same direction of interest
 + num: patients included in denom who has a highest post-baseline grade equal to 1
* for any:
 + denom: the number of patients with missing or less than the grade of interest at baseline, also post-baseline values must be in the same direction of interest
 + num: the number of patients satisfy either condition 1 or condition 2:
   - condition 1 (misisng baseline): patients included in denom who has missing at baseline
   - condition 2 (valid baseline): patients included in denom whose post-baseline grade is worse than baseline grade
```{r h_count}
h_worsen_counter <- function(df, id, .var, baseline_var, direction_var) {
  assertthat::assert_that(
    assertthat::is.string(id),
    assertthat::is.string(.var),
    assertthat::is.string(baseline_var),
    length(unique(df[[direction_var]])) == 1,
    unique(df[[direction_var]]) %in% c("High", "Low"),
    is_df_with_variables(df, list(val = c(id, .var, baseline_var, direction_var)))
  )

  # remove post-baseline missing
  df <- df[df[[.var]] != "<Missing>", ]

  # obtain directionality
  direction <- unique(df[[direction_var]])

  if (direction == "Low") {
    grade <- -1:-4
    worst_grade <- -4
  } else if (direction == "High") {
    grade <- 1:4
    worst_grade <- 4
  }


  if (nrow(df) > 0) {
    by_grade <- lapply(grade, function(i) {
      # filter baseline values that is less than i or <Missing>
      df_temp <- df[df[[baseline_var]] %in% c(0:(i - sign(i)), "<Missing>"), ]
      # ensure dirctionality is in the direction of interest
      df_temp <- df_temp[df_temp[[.var]] %in% grade, ]
      # num: number of patients with post-baseline worst lab equal to i
      num <- length(unique(df_temp[df_temp[[.var]] %in% i, id, drop = TRUE]))
      # denom: number of patients with baseline values less than i or <missing> and post-baseline in the same direction
      denom <- length(unique(df_temp[[id]]))
      rm(df_temp)
      c(num = num, denom = denom)
    })
  } else {
    by_grade <- lapply(1, function(i) {
      c(num = 0, denom = 0)
    })
  }

  names(by_grade) <- as.character(1:length(by_grade))

  # baseline grade less 4 or missing
  df_temp <- df[df[[baseline_var]] %in% c(0:(worst_grade - sign(worst_grade)), "<Missing>"), ]

  # ensure direction
  df_temp <- df_temp[df_temp[[.var]] %in% grade, ]

  # denom: number of patients with baseline values less than 4 or <missing> and post-baseline in the same direction
  denom <- length(unique(df_temp[, id, drop = TRUE]))

  # condition 1: missing baseline
  con1 <- which(df_temp[[baseline_var]] == "<Missing>")
  df_temp_nm <- df_temp[which(df_temp[[baseline_var]] != "<Missing>"), ]

  # condition 2: if post-baseline values are present then post-baseline values must be worse than baseline
  if (direction == "Low") {
    con2 <- which(as.numeric(as.character(df_temp_nm[[.var]])) < as.numeric(as.character(df_temp_nm[[baseline_var]])))
  } else {
    con2 <- which(as.numeric(as.character(df_temp_nm[[.var]])) > as.numeric(as.character(df_temp_nm[[baseline_var]])))
  }

  # number of patients satisfy either conditions 1 or 2
  num <- length(unique(df_temp[union(con1, con2), id, drop = TRUE]))

  list(fraction = c(by_grade, list("Any" = c(num = num, denom = denom))))
}

df_test <- expand.grid(
  ATOXGR = c(-4, -3, -2, -1, 0, 1, 2, 3, 4, "<Missing>"),
  BTOXGR = c(-4, -3, -2, -1, 0, 1, 2, 3, 4, "<Missing>")
)

df_test <- cbind(USUBJID = 1:100, df_test, GRADDR = "Low")

result <- h_worsen_counter(
  df_test,
  id = "USUBJID",
  .var = "ATOXGR",
  baseline_var = "BTOXGR",
  direction_var = "GRADDR"
)
```

## Statistic function:
```{r s_function}
s_count_abnormal_lab_worsen_by_baseline <- function(df, # nolint
                                                    .var = "ATOXGR",
                                                    variables = list(
                                                      id = "USUBJID",
                                                      baseline_var = "BTOXGR",
                                                      direction_var = "GRADDR"
                                                    )) {
  assertthat::assert_that(
    assertthat::is.string(.var),
    is_variables(variables),
    assertthat::is.string(variables$id),
    assertthat::is.string(variables$baseline_var),
    assertthat::is.string(variables$direction_var),
    setequal(names(variables), c("id", "baseline_var", "direction_var")),
    is_df_with_variables(df, c(aval = .var, variables[1:3]))
  )

  h_worsen_counter(df, variables$id, .var, variables$baseline_var, variables$direction_var)
}
```

## Analyze function
```{r}

a_count_abnormal_lab_worsen_by_baseline <- make_afun( # nolint
  s_count_abnormal_lab_worsen_by_baseline,
  .formats = c(fraction = format_fraction),
  .ungroup_stats = "fraction"
)

count_abnormal_lab_worsen_by_baseline <- function(lyt, # nolint
                                                  var,
                                                  variables = list(
                                                    id = "USUBJID",
                                                    baseline_var = "BTOXGR",
                                                    direction_var = "GRADDR"
                                                  ),
                                                  ...,
                                                  table_names = NULL,
                                                  .stats = NULL,
                                                  .formats = NULL,
                                                  .labels = NULL,
                                                  .indent_mods = NULL) {
  assertthat::assert_that(
    assertthat::is.string(var),
    setequal(names(variables), c("id", "baseline_var", "direction_var"))
  )

  afun <- make_afun(
    a_count_abnormal_lab_worsen_by_baseline,
    .stats = .stats,
    .formats = .formats,
    .labels = .labels,
    .indent_mods = .indent_mods
  )

  lyt <- analyze(
    lyt = lyt,
    vars = var,
    afun = afun,
    extra_args = c(list(variables = variables), list(...)),
    show_labels = "hidden"
  )

  lyt
}


basic_table() %>%
  split_cols_by("ARMCD") %>%
  add_colcounts() %>%
  split_rows_by("PARAMCD") %>%
  split_rows_by("GRADDR") %>%
  count_abnormal_lab_worsen_by_baseline(
    var = "ATOXGR",
    variables = list(
      id = "USUBJID",
      baseline_var = "BTOXGR",
      direction_var = "GRADDR"
    )
  ) %>%
  append_topleft("Direction of Abnormality") %>%
  build_table(df = df, alt_counts_df = adsl)
```
