---
title: "Design for helper function to create layout map for lbt07"
author: "Rosemary Li"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    theme: journal
    highlight: zenburn
vignette: >
  %\VignetteIndexEntry{Design of LBT04}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

Configuration
=============

```{r setup}
library(rtables)
library(tern)
library(dplyr)
library(assertthat)

packageVersion("tern")
packageVersion("rtables")
```

Introduction
=============

LBT07 used the function `count_abnormal_by_worst_grade` which will need a map for layout.

Design
=============

Maybe the function can get different `method` so that map for different templates can be created accordingly.

```{r eval=FALSE}
ext_ncictc4 <- haven::read_sas("metadata/ext_ncictc4.sas7bdat")
ext_ncictc4 <- usethis::use_data(ext_ncictc4)
```


```{r}
h_map_for_count_abnormal_by_worst_grade <- function(
  df,
  variables = list(anl = "ANRIND", split_rows = c("LBCAT", "PARAM"), range_low = "ANRLO", range_high = "ANRHI"),
  abnormal = list(low = c("LOW", "LOW LOW"), high = c("HIGH", "HIGH HIGH")),
  method = c("default", "range"),
  na_level = "<Missing>"
) {

}
```

STREAM data test
=============

```{r}
adsl <- ADSL %>% filter(SAFFL == "Y") %>% df_explicit_na()
adlb <- ADLB %>% df_explicit_na() %>%
  filter(ONTRTFL == "Y" & ATOXGR != "<Missing>" & PARCAT2 == "SI" & SAFFL == "Y")


```



Unit Tests
=============
```{r}
df <- data.frame(
  USUBJID = c(rep("1", 4), rep("2", 4), rep("3", 4)),
  AVISIT = c(
    rep("WEEK 1", 2), rep("WEEK 2", 2), rep("WEEK 1", 2), rep("WEEK 2", 2), rep("WEEK 1", 2), rep("WEEK 2", 2)
  ),
  PARAM = rep(c("ALT", "CPR"), 6),
  ANRIND = c("NORMAL", "NORMAL", "LOW", "HIGH", "LOW", "LOW", "HIGH", "HIGH", rep("NORMAL", 4))
)
df$ANRIND <- factor(df$ANRIND, levels = c("LOW", "HIGH", "NORMAL")) #nolint
```

```{r}
h_map_with_count_abnormal(
  df = df,
  split_rows_varibles = "PARAM",
  anl_variable = "ANRIND",
  abnormal = list(low = "LOW", high = "HIGH"),
  method = "both"
)
```
see difference between default and both
```{r}
df <- df %>% mutate(ANRIND = ifelse(PARAM == "ALT", "NORMAL", as.character(ANRIND)))
df$ANRIND <- factor(df$ANRIND, levels = c("LOW", "HIGH", "NORMAL")) #nolint
h_map_with_count_abnormal(
  df = df,
  split_rows_varibles = "PARAM",
  anl_variable = "ANRIND",
  abnormal = list(low = "LOW", high = "HIGH"),
  method = "default"
)
h_map_with_count_abnormal(
  df = df,
  split_rows_varibles = "PARAM",
  anl_variable = "ANRIND",
  abnormal = list(low = "LOW", high = "HIGH"),
  method = "both"
)
```

For lbt04, use stream real data to test
```{r}
ADLB <- haven::read_sas("../adlb.sas7bdat") %>% df_explicit_na() #nolint
adlb_f <- ADLB %>% filter(ONTRTFL == "Y" & ANRIND != "<Missing>" & PARCAT2 == "SI")

h_map_with_count_abnormal(
  df = adlb_f %>% filter(LBCAT != "<Missing>"),
  split_rows_varibles = c("LBCAT", "PARAM"),
  anl_variable = "ANRIND",
  abnormal = list(low = "LOW", high = "HIGH"),
  method = "lbt04"
)
```

