---
title: "Design for helper function to create layout map for lbt07"
author: "Rosemary Li"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    theme: journal
    highlight: zenburn
vignette: >
  %\VignetteIndexEntry{Design of LBT07}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

Configuration
=============

```{r setup}
library(rtables)
library(tern)
library(dplyr)
library(assertthat)

packageVersion("tern")
packageVersion("rtables")
```

Introduction
=============

LBT07 used the function `count_abnormal_by_worst_grade` which will need a map for layout.

For STREAM, there's a meta data called ext_ncitct4 which is the grading criteria for lab abnormality, see reference here
https://pages.github.roche.com/MDIS/stream_doc/um/vad_concept_grading.html

Based on the above grading criteria, two reference datasets were created called `__atoxgr_low_ref.sas7bdat` and
`__atoxgr_high_ref.sas7bdat` which were used as the lab abnormal direction reference for both LBT07 and LBT15. All the
three meta datasets can be found on bee with the path `/opt/bee/analyses/stream2/master/current/stream2/app/metadata/`

The idea here is to derive the map used in `trim_levels_to_map` directly from `ext_ncitct4`.

Design
=============

The below steps are just to store the ext_ncitct4 data as rda file. After this, use `data("ext_ncitct4")` to load data.
```{r eval=FALSE}
ext_ncictc4 <- haven::read_sas("metadata/ext_ncictc4.sas7bdat")
ext_ncictc4 <- usethis::use_data(ext_ncictc4)
```

This helper function replies on user to put the correct `variables$split_rows` in the same order as their layout.
Also the `abnormal` is the value that they used in pre-processing.
```{r}
h_map_for_count_abnormal_by_worst_grade <- function(
  df,
  variables = list(anl = "GRADE_ANL", split_rows = c("PARAM", "GRADE_DIR")),
  abnormal = list(low = "LOW", high = "HIGH"),
  na_level = "<Missing>"
) {
  last_split_var <- variables$split_rows[-1]
  assertthat::assert_that(
    is_df_with_variables(df, variables),
    "anl" %in% names(variables),
    "split_rows" %in% names(variables),
    "PARAM" %in% unlist(variables) || "PARAMCD" %in% unlist(variables),
    is_df_with_factors(df, variables),
    any(unlist(abnormal) %in% levels(df[[last_split_var]])) # This is to check if the abnormals are the same as pre-processing #nolint
  )
  data("ext_ncictc4")
  ext_ncictc4 <- ext_ncictc4[c("PARAMCD", "RESULT")]
  ext_ncictc4 <- ext_ncictc4[ext_ncictc4[["PARAMCD"]] %in% unique(df[["PARAMCD"]]), ]
  ext_ncictc4[[last_split_var]] <- na_level
  ext_ncictc4[ext_ncictc4[["RESULT"]] %in% c("1", "2", "3", "4"), ][[last_split_var]] <- abnormal$high
  ext_ncictc4[ext_ncictc4[["RESULT"]] %in% c("-1", "-2", "-3", "-4"), ][[last_split_var]] <- abnormal$low
  ext_ncictc4 <- unique(ext_ncictc4[ext_ncictc4[[last_split_var]] != na_level, ][c("PARAMCD", last_split_var)]) #nolint

  if ("PARAMCD" %in% variables$split_rows) {
    map <- unique(df[c(variables$split_rows, variables$anl)])
    map <- map[map[[last_split_var]] %in% unlist(abnormal), ]
    map <- merge(map, ext_ncictc4, all = TRUE)
  } else {
    map <- unique(df[c(variables$split_rows, "PARAMCD", variables$anl)])
    map <- map[map[[last_split_var]] %in% unlist(abnormal), ]

    # Below is to include other variables into the ext_ncictc4 otherwise PARAM will be NA in the final map
    param_map <- unique(df[c(head(variables$split_rows, -1), "PARAMCD")])
    ext_ncictc4 <- merge(ext_ncictc4, param_map)
    map <- merge(map, ext_ncictc4, all = TRUE)
  }

  map <- data.frame(lapply(map, as.character), stringsAsFactors = FALSE)
  map <- map[c(variables$split_rows, variables$anl)]
  map[[variables$anl]][is.na(map[[variables$anl]])] <- "Any"
  map
}
```

STREAM data test
=============

Below codes are just to read in STREAM data. The source data is deleted after data got read in the envrionment.
```{r eval=FALSE}
library(forcats)

ADSL <- haven::read_sas("data/adsl.sas7bdat")
ADLB <- haven::read_sas("data/adlb.sas7bdat")

adsl <- ADSL %>% filter(SAFFL == "Y") %>% df_explicit_na()
adlb <- ADLB %>% df_explicit_na() %>%
  filter(ONTRTFL == "Y" & ATOXGR != "<Missing>" & PARCAT2 == "SI" & SAFFL == "Y")
adlb_f <- adlb %>%
  mutate(
    GRADE_DIR = factor(case_when(
      ATOXGR %in% c("-1", "-2", "-3") ~ "LOW",
      ATOXGR == "0" ~ "ZERO",
      ATOXGR %in% c("1", "2", "3") ~ "HIGH"),
      levels = c("LOW", "ZERO", "HIGH")),
    GRADE_ANL = fct_relevel(
      fct_recode(ATOXGR,
                 `1` = "-1", `2` = "-2", `3` = "-3"),
      c("0", "1", "2", "3")
    )
  ) %>%
  filter(WGRLOFL == "Y" | WGRHIFL == "Y") %>%
  droplevels()
levels(adlb_f$GRADE_ANL) <- c("0", "1", "2", "3", "Any")
#I had to add "any" into the levels of analysis variable `GRADE_ANL` for the functions to work. Not sure if there's
#better way to handle this.
```

Pre-processing
```{r}
library(forcats)
library(scda) # scda is only for knit to work

adsl <- synthetic_cdisc_data("latest")$adsl
adlb <- synthetic_cdisc_data("latest")$adlb
adlb[["PARCAT2"]] <- "SI" # only for knit to work

adsl <- adsl %>% filter(SAFFL == "Y") %>% df_explicit_na()
adlb <- adlb %>% df_explicit_na() %>%
  filter(ONTRTFL == "Y" & ATOXGR != "<Missing>" & PARCAT2 == "SI" & SAFFL == "Y")
adlb_f <- adlb %>%
  mutate(
    GRADE_DIR = factor(case_when(
      ATOXGR %in% c("-1", "-2", "-3") ~ "LOW",
      ATOXGR == "0" ~ "ZERO",
      ATOXGR %in% c("1", "2", "3") ~ "HIGH"),
      levels = c("LOW", "ZERO", "HIGH")),
    GRADE_ANL = fct_relevel(
      fct_recode(ATOXGR,
                 `1` = "-1", `2` = "-2", `3` = "-3"),
      c("0", "1", "2", "3")
    )
  ) %>%
  filter(WGRLOFL == "Y" | WGRHIFL == "Y") %>%
  droplevels()
levels(adlb_f$GRADE_ANL) <- c("0", "1", "2", "3", "4", "Any")
```

Build LBT07
```{r}
# The commented-out codes were what used to create the map
# map <- adlb_f %>% select(PARAMCD, GRADE_DIR, GRADE_ANL) %>% unique() %>% filter(GRADE_DIR != "ZERO")
# map <- ext_ncictc4 %>% left_join(map, by = c("PARAMCD", "GRADE_DIR")) %>% unique() %>% arrange(PARAMCD)
# map <- map %>% mutate(GRADE_ANL = ifelse(is.na(GRADE_ANL), "Any", as.character(GRADE_ANL)))

map <- h_map_for_count_abnormal_by_worst_grade(
  df = adlb_f
)

basic_table() %>%
  split_cols_by("ARMCD") %>%
  add_colcounts() %>%
  split_rows_by("PARAM") %>%
  summarize_num_patients(
    var = "USUBJID",
    required = "GRADE_DIR",
    .stats = "unique_count"
  ) %>%
  split_rows_by("GRADE_DIR", split_fun = trim_levels_to_map(map)) %>%
  count_abnormal_by_worst_grade(
    var = "GRADE_ANL",
    variables = list(id = "USUBJID", param  = "PARAM", grade_dir = "GRADE_DIR")
  ) %>%
  build_table(df = adlb_f, alt_counts_df = adsl)

```
