---
title: "Design for AE by grade table (AET04)"
author: "Jana Stoilova"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    theme: journal
    highlight: zenburn
vignette: >
  %\VignetteIndexEntry{Design of AET04}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

Configuration
=============

```{r setup}
library(rtables)
library(tern)
library(assertthat)
library(dplyr)

packageVersion("tern")
packageVersion("rtables")
```

Data for examples
=================

```{r data, results = "asis", eval = TRUE}

library(random.cdisc.data)

adsl <- radsl(cached = TRUE)
adae <- radae(cached = TRUE)

adae$AEDECOD2 <- as.character(adae$AEDECOD) # nolint
adae$AEBODSYS2 <- as.character(adae$AEBODSYS) # nolint

anl <- adae %>%
  filter(AEDECOD %in% c("dcd A.1.1.1.1", "dcd A.1.1.1.2") | AEBODSYS == "cl B.1")

df <- data.frame(
  USUBJID = as.character(c(1:5, 1)),
  ATOXGR = factor(c(1, 2, 3, 1, 2, 3), levels = c(1:5)),
  AESEV = factor(c("MILD", "MODERATE", "SEVERE", "MILD", "MODERATE", "SEVERE")),
  ARM = factor(c("A", "A", "A", "B", "B", "A")),
  stringsAsFactors = FALSE
)

big_n <- length(unique(anl$USUBJID))
```

Design Summary
==============

- Preferred approach with `summarize_row_groups`
  - The [set of commands to create AET04](#aet04-table-with-more-data) is a bit lengthy so it may be helpful to make some wrapper functions.
  - Tabulation layout now matches (mostly) AET04 template.
  - `rtables` dependencies (nice-to-have):
    - ability to repeat multiple `summarize_row_groups` functions within a layout
    - `trim_rows` should not drop content rows with "" which may hold a label
    - In `make_afun` it would be nice to be able to use `.stats` to select elements to keep in the display without
    having to also specify `.formats` and `.indent_mods`. For example see `summarize_grade_per_id`
    in the [layout functions](#basic-table-functions).
  - With content rows, the sorting is easy as can apply directly rtables functions
- Original approach
  - Tabulation layout can match AET04 template.
  - Sorting functions for term and class levels is difficult to control because it's not easy to distinguish summary rows
  from other rows in sub-tables.

Approach with `summarize_row_groups`
====================================

Basic table functions {.tabset}
-------------------------------

### Statistics Functions

```{r, sfun}
s_count_grade_per_id <- function(df,
                                 .var,
                                 .N_col, # nolint
                                 variables = list(id = "USUBJID")) {
  assertthat::assert_that(
    assertthat::noNA(df[, c(.var, variables$id)]),
    is.factor(df[[.var]])
  )

  id <- df[[variables$id]] # nolint
  grade <- df[[.var]]

  grade <- factor(grade, levels = levels(grade), ordered = TRUE) # needed to take maximum
  df_max <- aggregate(grade ~ id, FUN = max, drop = FALSE)

  l_count <- as.list(table(df_max$grade))

  l_count_percent <- lapply(l_count, function(i, denom) c(i, i / denom), denom = .N_col)

  list(
    count_percent = l_count_percent
  )
}

s_count_grade_per_id(df, .var = "ATOXGR", .N_col = 10)
s_count_grade_per_id(df, .var = "AESEV", .N_col = 10)

s_count_grade_per_id_content <- function(df,
                                         labelstr = "",
                                         .N_col, # nolint
                                         .var,
                                         variables = list(id = "USUBJID", top_label = "- Any adverse events -")) {
  assertthat::assert_that(
    is.data.frame(df),
    assertthat::is.string(.var)
  )

  top_label <- variables$top_label
  result <- s_count_grade_per_id(
    df = df,
    .var = .var,
    .N_col = .N_col,
    variables = variables
  )
  any_grade <- sum(vapply(tern:::flatten_list(result), `[[`, i = 1, numeric(1)))
  any <- list("any" = formatable::with_label(c(any_grade, any_grade / .N_col), "- Any Grade -"))

  c(top_label = list(formatable::with_label("", top_label)), any, result)
}

s_count_grade_per_id_content(df, .var = "ATOXGR", .N_col = 10)
s_count_grade_per_id_content(df, .var = "AESEV", .N_col = 10)
```

### Layout Functions
- "- Any Grade -" and "- Any adverse events - " rows added since it's currently not possible to chain `summarize_row_groups`
```{r, layout_functions}

count_grade_per_id <- function(lyt, vars, ...) {
  afun <- tern:::format_wrap_df(
    s_count_grade_per_id,
    indent_mods = c(count_percent = 0L),
    formats = c(count_percent = "xx (xx.x%)")
  )

  analyze(
    lyt = lyt,
    vars = vars,
    afun = afun,
    extra_args = list(...)
  )
}

basic_table() %>%
  split_cols_by("ARM") %>%
  add_colcounts() %>%
  count_grade_per_id(vars = "ATOXGR") %>%
  build_table(df, col_counts = table(df$ARM))

# count_percent list includes flexible grade levels
summarize_grade_per_id <- function(lyt,
                                   var,
                                   .stats = c("top_label", "any", "count_percent"),
                                   .formats = c(top_label = "xx", any = "xx (xx.x%)", "count_percent" = "xx (xx.x%)"),
                                   .indent_mods = c("top_label" = 0L, "any" = 1L, "count_percent" = 1L),
                                   ...) {
  c_grade_per_id <- make_afun(
    s_count_grade_per_id_content,
    .stats = .stats,
    .formats = .formats,
    .ungroup_stats = "count_percent",
    .indent_mods = .indent_mods
  )

  summarize_row_groups(
    lyt = lyt,
    var = var,
    cfun = c_grade_per_id,
    indent_mod = 1L,
    extra_args = list(...)
  )
}


# NOTE: when changing the default stats displayed, need to specify .stats, .formats and .indent_mods
# in order for tabulation to work
basic_table() %>%
  split_cols_by("ARM") %>%
  add_colcounts() %>%
  summarize_grade_per_id(
    var = "ATOXGR",
    .stats = c("any", "count_percent"),
    .formats = c("any" = "xx (xx.x%)", "count_percent" = "xx (xx.x%)"),
    .indent_mods = c("any" = 0L, "count_percent" = 0L)
  ) %>%
  build_table(df, col_counts = table(df$ARM))

basic_table() %>%
  split_cols_by("ARM") %>%
  add_colcounts() %>%
  summarize_grade_per_id(var = "AESEV") %>%
  build_table(df, col_counts = table(df$ARM))
```

AET04 layout variants {.tabset}
-------------------------------

### Split only by AEDECOD

- Reusing `summarize_num_patients` developed from `AET06` template.

```{r aet04_examples_cfun}

basic_table() %>%
  split_cols_by("STUDYID") %>%
  add_colcounts() %>%
  split_rows_by("AEDECOD2", child_labels = "visible", nested = FALSE) %>%
  summarize_num_patients(
    var = "USUBJID",
    .stats = "unique",
    .labels = c("- Any Grade -")
  ) %>%
  count_grade_per_id(vars = "AETOXGR") %>%
  build_table(anl, col_counts = big_n)
```

### Split by AEBODSYS and AEDECOD

- Reusing `summarize_num_patients` developed from `AET06` template.

- Not able to chain multiple `summarize_row_groups`.

- For now, at the SOC-level "- Any Grade -" row is part of content rows (until it's possible to chain `summarize_row_groups`).

```{r aet04_examples_cfun2}

basic_table() %>%
  split_cols_by("STUDYID") %>%
  add_colcounts() %>%
  split_rows_by("AEBODSYS2", child_labels = "visible", nested = TRUE) %>%
  summarize_grade_per_id(
    var = "AETOXGR",
    .stats = c("any", "count_percent"),
    .formats = c("any" = "xx (xx.x%)", "count_percent" = "xx (xx.x%)"),
    .indent_mods = c("any" = 0L, "count_percent" = 0L)
  ) %>%
  split_rows_by("AEDECOD2", child_labels = "visible", nested = TRUE) %>%
  summarize_num_patients(
    var = "USUBJID",
    .stats = "unique",
    .labels = c("- Any Grade -")
  ) %>%
  count_grade_per_id(vars = "AETOXGR") %>%
  build_table(anl, col_counts = big_n)
```

### Match AET04 layout

- Reusing `summarize_num_patients` developed from `AET06` template.

- Not able to chain multiple `summarize_row_groups`.

- This example adds the top rows summarizing across all occurrences.

- The content rows in "- Any adverse events -" and "- Any Grade -" by default unless `summarize_grade_per_id` is modified.

- Some issues with indentation.
```{r, aet04_examples_cfun3}
basic_table() %>%
  split_cols_by("STUDYID") %>%
  add_colcounts() %>%
  summarize_grade_per_id(var = "AETOXGR") %>%
  split_rows_by("AEBODSYS2", child_labels = "visible", nested = TRUE) %>%
  summarize_grade_per_id(
    var = "AETOXGR",
    .stats = c("any", "count_percent"),
    .formats = c("any" = "xx (xx.x%)", "count_percent" = "xx (xx.x%)"),
    .indent_mods = c("any" = 0L, "count_percent" = 0L)
  ) %>%
  split_rows_by("AEDECOD2", child_labels = "visible", nested = TRUE) %>%
  summarize_num_patients(
    var = "USUBJID",
    .stats = "unique",
    .labels = c("- Any Grade -")
  ) %>%
  count_grade_per_id(vars = "AETOXGR") %>%
  build_table(anl, col_counts = big_n)
```

Sorting {.tabset}
------------------------

Note: when trimming the table the "- Any adverse events -" row is dropped. Need to come up
with a workaround.

### Table to sort
```{r, table_to_sort_cfun}
tbl_to_trim <- basic_table() %>%
  split_cols_by("ARM", split_fun = add_overall_level("All Patients", first = FALSE)) %>%
  add_colcounts() %>%
  summarize_grade_per_id(var = "AETOXGR") %>%
  split_rows_by("AEBODSYS2", child_labels = "visible", nested = TRUE) %>%
  summarize_grade_per_id(
    var = "AETOXGR",
    .stats = c("any", "count_percent"),
    .formats = c("any" = "xx (xx.x%)", "count_percent" = "xx (xx.x%)"),
    .indent_mods = c("any" = 0L, "count_percent" = 0L)
  ) %>%
  split_rows_by("AEDECOD2", child_labels = "visible", nested = TRUE) %>%
  summarize_num_patients(
    var = "USUBJID",
    .stats = "unique",
    .labels = c("- Any Grade -")
  ) %>%
  count_grade_per_id(vars = "AETOXGR") %>%
  build_table(anl, col_counts = c(table(anl$ARM), nrow(anl)))

tbl_to_trim

# now trim rows
tbl <- trim_rows(tbl_to_trim)
tbl
```


### Apply sort functions

- Default functions provide provided with `rtables` work
- If total column is not present, can use `cont_n_allcols`
- Perhaps it's helpful to wrap up this chain of functions in an easy-to-use default function?

```{r, custom_sort_for_cfun}

tbl_pt_sorted <- sort_at_path(
  tbl,
  path = c("AEBODSYS2", "*", "AEDECOD2"),
  scorefun = cont_n_onecol(4),
  decreasing = TRUE
)

tbl_final <- sort_at_path(
  tbl_pt_sorted,
  path = c("AEBODSYS2"),
  scorefun = cont_n_onecol(4),
  decreasing = TRUE
)

tbl_final
```

AET04 table with more data
--------------------------

This is pretty close to what is needed per specification but set of commands is a bit long.

```{r, aet04_big_table_cfun}

basic_table() %>%
  split_cols_by("ARM", split_fun = add_overall_level("All Patients", first = FALSE)) %>%
  add_colcounts() %>%
  summarize_grade_per_id(var = "AETOXGR") %>%
  split_rows_by("AEBODSYS2", child_labels = "visible", nested = TRUE, indent_mod = -1L) %>%
  summarize_grade_per_id(
    var = "AETOXGR",
    .stats = c("any", "count_percent"),
    .formats = c("any" = "xx (xx.x%)", "count_percent" = "xx (xx.x%)"),
    .indent_mods = c("any" = 0L, "count_percent" = 0L)
  ) %>%
  split_rows_by("AEDECOD2", child_labels = "visible", nested = TRUE, indent_mod = -1L) %>%
  summarize_num_patients(
    var = "USUBJID",
    .stats = "unique",
    .labels = c("- Any Grade -")
  ) %>%
  count_grade_per_id(vars = "AETOXGR") %>%
  build_table(adae, col_counts = c(table(adsl$ARM), nrow(adsl))) %>%
  #  trim_rows() %>% #comment out so to keep top row "- Any adverse events -"
  sort_at_path(
    path = c("AEBODSYS2"),
    scorefun = cont_n_onecol(4),
    decreasing = TRUE
  ) %>%
  sort_at_path(
    path = c("AEBODSYS2", "*", "AEDECOD2"),
    scorefun = cont_n_onecol(4),
    decreasing = TRUE
  )
```
