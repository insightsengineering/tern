---
title: "NCI CTCAE Grade Laboratory Abnormalities by Visit and Baseline Grade (LBT13)"
author: "Rosemary Li"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Design of LBT10}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

Configuration
=============

```{r setup}
library(dplyr)
library(tern)

packageVersion("tern")
packageVersion("rtables")
```

Data for examples
=================

```{r data, results = "asis", eval = TRUE}

adlb <- haven::read_sas(data_file = "adlb.sas7bdat")
adsl <- haven::read_sas(data_file = "adsl.sas7bdat")

# Filter datasets based on STREAM conditions
adsl <- adsl %>% filter(SAFFL == "Y") %>% df_explicit_na()
adlb <- adlb %>% filter(PARCAT2 == "SI" & WGRLOVFL == "Y" & SAFFL == "Y") %>% df_explicit_na()

# Create ATOXGR_GP and BTOXGR_GP to get rid of helpfer function
adlb <- adlb %>% mutate(
  ATOXGR_GP = case_when(
    ATOXGR %in% c(0, 1, 2, 3, 4) ~ "Not Low",
    ATOXGR == -1 ~ "1",
    ATOXGR == -2 ~ "2",
    ATOXGR == -3 ~ "3",
    ATOXGR == -4 ~ "4",
    ATOXGR == "<Missing>" ~ "Missing"
  )
) %>%
  mutate(
    BTOXGR_GP = case_when(
      BTOXGR %in% c(0, 1, 2, 3, 4) ~ "Not Low",
      BTOXGR == -1 ~ "1",
      BTOXGR == -2 ~ "2",
      BTOXGR == -3 ~ "3",
      BTOXGR == -4 ~ "4",
      BTOXGR == "<Missing>" ~ "Missing"
    )
)

# adjust factor levels for correct order of AVISIT and Grouping to show
## maybe there should be some function in tern to take care of AVISIT factor level according to AVISITN?
adlb <- adlb %>% mutate(
  AVISIT = factor(AVISIT, levels = c("WEEK 1", "WEEK 2", "WEEK 3", "WEEK 4", "WEEK 5", "WEEK 7",
                                     "WEEK 9", "WEEK 13", "WEEK 17", "WEEK 21", "UNSCHEDULED")),
  ATOXGR_GP = factor(ATOXGR_GP, levels = c("Not Low", "1", "2", "3", "4", "Missing")),
  BTOXGR_GP = factor(BTOXGR_GP, levels = c("Not Low", "1", "2", "3", "4", "Missing"))
)
```

Layout
======

Use `count_occurrences` and `drop = T` for variant 1-4.
```{r}
basic_table() %>%
  split_cols_by("ACTARM") %>%
  add_colcounts() %>%
  split_rows_by("PARAMCD", label_pos = "topleft") %>%
  split_rows_by("AVISIT", split_fun = remove_split_levels(c("UNSCHEDULED")), label_pos = "topleft") %>%
  split_rows_by("ATOXGR_GP", split_fun = drop_split_levels, label_pos = "topleft") %>%
  summarize_num_patients(var = "USUBJID", .stats = c("unique_count")) %>%
  count_occurrences("BTOXGR_GP", denom = "n", drop = T) %>%
  append_varlabels(adlb, "BTOXGR_GP", indent = 3L) %>%
  build_table(df = adlb, alt_counts_df = adsl)
```

Use `count_occurrences` and `drop = F` for variant 5.
```{r}
result <- basic_table() %>%
  split_cols_by("ACTARM") %>%
  add_colcounts() %>%
  split_rows_by("PARAMCD", label_pos = "topleft") %>%
  split_rows_by("AVISIT", split_fun = remove_split_levels(c("UNSCHEDULED")), label_pos = "topleft") %>%
  split_rows_by("ATOXGR_GP", split_fun = drop_split_levels, label_pos = "topleft") %>%
  summarize_num_patients(var = "USUBJID", .stats = c("unique_count")) %>%
  count_occurrences("BTOXGR_GP", denom = "n", drop = F) %>%
  append_varlabels(adlb, "BTOXGR_GP", indent = 3L) %>%
  build_table(df = adlb, alt_counts_df = adsl)

Viewer(result)
```


Use the current `count_abnormal_by_worst_grade_by_baseline` for all PARAMCDs, yield varaint 5

```{r}
result <- basic_table() %>%
  split_cols_by("ACTARM") %>%
  add_colcounts() %>%
  split_rows_by("PARAMCD", label_pos = "topleft") %>%
  split_rows_by("AVISIT", split_fun = remove_split_levels(c("UNSCHEDULED")), label_pos = "topleft") %>%
  count_abnormal_by_worst_grade_by_baseline(
    var = "BTOXGR",
    grouping_list = list(
      "Not Low" = c(0, 1, 2, 3, 4),
      "1" = -1,
      "2" = -2,
      "3" = -3,
      "4" = -4,
      "Missing" = "<Missing>"
    ),
    variables = list(
      id = "USUBJID",
      by_var = "ATOXGR"
    )
  ) %>%
  append_topleft("NCI-CTCAE Grade at Visit") %>%
  append_topleft("  Baseline NCI-CTCAE Grade") %>%
  build_table(df = adlb, alt_counts_df = adsl)

Viewer(result)
```


For variant 1-4:
- variant 1: WGRLOVFL == "Y"
- variant 2: WGRHIVFL == "Y"
- variant 3: exclude BTOXGR == "<Missing>"
- variant 4: When assigning ATOXGR_GP and BTOXGR_GP, include missing to grade 0

