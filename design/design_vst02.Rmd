---
title: "Vital Sign Abnormalities (Regardless of Abnormality at Baseline) (VST02_1)"
author: "Saibah Chohan"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    number_sections: true
    theme: journal
    highlight: zenburn
vignette: >
  %\VignetteIndexEntry{design_vst02}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: ../inst/REFERENCES.bib

---
Configuration
=============

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

```{r setup}
library(rtables)
packageVersion("rtables")

library(tern)
library(random.cdisc.data)
library(dplyr)
```

We want something like this:
                                                                   A: Drug X                   B: Placebo                 C: Combination                All Patients     
Parameter                       Abnormality Direction               (N=134)                      (N=134)                      (N=132)                      (N=400)       
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Diastolic Blood Pressure                 LOW                    53/134 (39.6%)               57/134 (42.5%)               54/132 (40.9%)                164/400 (41%)    
                                        HIGH                    53/134 (39.6%)               51/134 (38.1%)               52/132 (39.4%)                156/400 (39%)    

Pulse Rate                               LOW                     63/134 (47%)                53/134 (39.6%)               50/132 (37.9%)               166/400 (41.5%)   
                                        HIGH                    52/134 (38.8%)               57/134 (42.5%)               39/132 (29.5%)                148/400 (37%)    

Respiratory Rate                         LOW                     59/134 (44%)                49/134 (36.6%)               45/132 (34.1%)               153/400 (38.2%)   
                                        HIGH                    62/134 (46.3%)               54/134 (40.3%)                62/132 (47%)                178/400 (44.5%)   

Systolic Blood Pressure                  LOW                    54/134 (40.3%)                55/134 (41%)                57/132 (43.2%)               166/400 (41.5%)   
                                        HIGH                    58/134 (43.3%)               49/134 (36.6%)               52/132 (39.4%)               159/400 (39.8%)   

Temperature                              LOW                     59/134 (44%)                50/134 (37.3%)               61/132 (46.2%)               170/400 (42.5%)   
                                        HIGH                    45/134 (33.6%)               54/134 (40.3%)               52/132 (39.4%)               151/400 (37.8%)   

Weight                                   LOW                    62/134 (46.3%)               57/134 (42.5%)               63/132 (47.7%)               182/400 (45.5%)   
                                        HIGH                    54/134 (40.3%)               58/134 (43.3%)               55/132 (41.7%)               167/400 (41.8%)   



This design does not imitate the above STREAM template exactly. We cannot have a separate column for "Abnormality Direction" at the moment. 


```{r data peprocessing}
adsl <- radsl(cached = TRUE)
advs <- radvs(cached = TRUE)
advs_label <- formatters::var_labels(advs)

# This table intends to only provide during treatment abnormalities.
# Hence, we keep treatment abnormalities only and remove baseline/screening abnormalities.
advs_f <- advs %>% filter(ABLFL != "Y" & ABLFL2 != "Y")

n_col_counts <- table(adsl$ARM)
n_col_counts <- c(n_col_counts, sum(n_col_counts))
```

### Functions 

#### `count_abnormal`

```{r}
library(tern)
count_abnormal
```

#### Default output

```{r }
result <- basic_table() %>%
  split_cols_by("ARM", split_fun = add_overall_level("All Patients", first = FALSE)) %>%
  add_colcounts() %>%
  split_rows_by("PARAM", split_label = c("Parameter / Abnormality Direction"), visible_label = TRUE) %>%
  count_abnormal("ANRIND", abnormal = c(Low = "LOW", High = "HIGH")) %>%
  build_table(df = advs_f, col_counts = n_col_counts) %>%
  as_html()
result
```
