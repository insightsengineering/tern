---
title: "ECG Abnormalities (EGT02)"
author: "Francois Collin"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    number_sections: true
    theme: journal
    highlight: zenburn
vignette: >
  %\VignetteIndexEntry{design_egt02}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: ../inst/REFERENCES.bib

---

Links:

- [https://github.roche.com/NEST/tern/issues/712](https://github.roche.com/NEST/tern/issues/712)
- [TLG Catalog](https://nest-docs.kubemea.science.roche.com/releases/2020_08_20/embedded/agile-R/tlg_catalog/tables/egt02/)
- [GDSR](https://gdsr.roche.com/resource/gdsr.roche.com/release/products/dataAnalysis/GDS_Standard_TLG_Specs_Tables_1.doc) [@Hughes2020]
- [EGT02_1](https://pages.github.roche.com/MDIS/stream_doc/um/report_outputs_egt02_1.html)
- [EGT02_2](https://pages.github.roche.com/MDIS/stream_doc/um/report_outputs_egt02_2.html)

Configuration
=============

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

```{r setup}
library(rtables)
library(tern)
packageVersion("rtables")
packageVersion("tern")

library(tern)
library(random.cdisc.data)
library(dplyr)
library(testthat)
```


> This design does not imitate the above STREAM template exactly. We cannot have a separate column for
  "Abnormality Direction" at the moment. (S.Chohan in VST02 vignette)


Variants
========

ECG Abnormalities (Regardless of Abnormality at Baseline)
---------------------------------------------------------

Estimating `ECG02_1` did not require further development. The existing function and `rtables` pipeline
programmed for `VST02_1` gives the expected result.

```{r data peprocessing}
adsl <- radsl(cached = TRUE)

# Only keep post baseline visits
adeg <- radeg(cached = TRUE) %>%
  filter(ONTRTFL == "Y" & !is.na(ANRIND) & AVISITN >= 1) %>%
  mutate(PARAM = droplevels(PARAM))

n_col_counts <- table(adsl$ARM)
n_col_counts <- c(n_col_counts, Total = sum(n_col_counts))

```

```{r egt02_1}
result <- basic_table() %>%
  split_cols_by("ARM", split_fun = add_overall_level("All Patients", first = FALSE)) %>%
  add_colcounts() %>%
  split_rows_by(
    "PARAM",
    split_label = c("Parameter / Analysis Reference Range Indicator"),
    visible_label = TRUE
  ) %>%
  count_abnormal("ANRIND", abnormal = c(Low = "LOW", High = "HIGH")) %>%
  build_table(df = adeg, col_counts = n_col_counts)

as_html(result)
```

ECG Abnormalities (Without the Abnormality at Baseline)
------------------------------------------------------

The only difference is a question of data filtering. If the data at baseline
are included (`AVISITN >= 0`) then patient which presented the abnormality at baseline
will not be accounted for.

```{r}
adsl <- radsl(cached = TRUE)

adeg <- radeg(cached = TRUE) %>%
  filter(ONTRTFL == "Y" & !is.na(ANRIND) & AVISITN >= 0) %>%
  mutate(PARAM = droplevels(PARAM))

n_col_counts <- table(adsl$ARM)
n_col_counts <- c(n_col_counts, Total = sum(n_col_counts))

result <- basic_table() %>%
  split_cols_by("ARM", split_fun = add_overall_level("All Patients", first = FALSE)) %>%
  add_colcounts() %>%
  split_rows_by(
    "PARAM",
    split_label = c("Parameter / Analysis Reference Range Indicator"),
    visible_label = TRUE
  ) %>%
  count_abnormal("ANRIND", abnormal = c(Low = "LOW", High = "HIGH")) %>%
  build_table(df = adeg, col_counts = n_col_counts)

as_html(result)

```

Reference
=========
