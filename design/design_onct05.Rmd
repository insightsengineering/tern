---
title: "Design for ONCT05"
author: "Jana Stoilova"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    theme: journal
    highlight: zenburn
vignette: >
  %\VignetteIndexEntry{Design of ONCT05}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options:
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

## Configuration

```{r setup}
library(rtables)
library(tern)
library(assertthat)
library(dplyr)

packageVersion("tern")
packageVersion("rtables")
```

## Data for examples

```{r data, results = "asis", eval = TRUE}

library(random.cdisc.data)
adrs <- radrs(cached = TRUE)
adrs_labels <- formatable::var_labels(adrs)

adrs <- adrs %>%
  filter(PARAMCD == "BESRSPI") %>%
  filter(ARM %in% c("A: Drug X", "B: Placebo")) %>%
  droplevels() %>%
  mutate(
    rsp = AVALC %in% c("CR"),
    # Reorder levels of factor to make the placebo group the reference arm.
    ARM = forcats::fct_relevel(ARM, "B: Placebo")
  )
formatable::var_labels(adrs) <- c(adrs_labels, "Response")
```

## Objective



````
                                        ARM A          ARM B
                                       (N=187)        (N=182)
                                    _____________  _____________

                              Total       Response       Response   Odds
Baseline Risk Factors          n     n     (%)      n     (%)      Ratio       95% CI
__________________________________________________________________________________________

All Patients                  369   187    49.7    182    50.0       1.01  (0.67,    1.52)

Sex
  Male                        189   103    49.5     86    53.5       1.17  (0.66,    2.08)
  Female                      180    84    50.0     96    46.9       0.88  (0.49,    1.59)

Pooled Age Group 1
  <65                         267   131    48.1    136    49.3       1.05  (0.65,    1.69)
  >=65                        102    56    53.6     46    52.2       0.95  (0.43,    2.07)
````


Details: (see GDSR)

## Design Summary

- Helper function returns two summary datasets which need to be converted to rtables separately.
- One summary dataset is used to create a summary table by arm.
- The second summary dataset is used to create the table of total n, odds ratio and ci.
- In a final step, the tables are combined using `cbind_rtable`.


## Helper function to create tidy dataset(s)

- Reuse as many functions from `RSPT01` template.

- Need to add control function for changing default settings.

```{r, helpers}

h_extract_subgroup_or <- function(variables, data) {
  assertthat::assert_that(
    is.character(variables$rsp),
    is.character(variables$arm),
    is.character(variables$subsets),
    is_df_with_variables(data, as.list(unlist(variables)))
  )

  rsp <- variables$rsp
  arm <- variables$arm
  arm_ref <- levels(data[[arm]])[1]
  subset_labels <- formatable::var_labels(data[, variables$subsets], fill = TRUE)

  l_result <- lapply(variables$subsets, function(subset_i) {
    l_data <- split(data, data[[subset_i]])

    l_df <- lapply(l_data, function(df) {
      df_comp <- df[df[[arm]] == arm_ref, ]
      df_ref <- df[df[[arm]] != arm_ref, ]

      # Response rates.
      result_all <- s_proportion(df[[variables$rsp]])

      # Odds ratio and CI
      result_odds_ratio <- s_odds_ratio(
        df = df_comp,
        .var = rsp,
        .ref_group = df_ref,
        .in_ref_col = FALSE
      )

      # Test for difference.
      result_test <- s_test_proportion_diff(
        df = df_comp,
        .var = rsp,
        .ref_group = df_ref,
        .in_ref_col = FALSE,
        variables = list(strata = NULL), # TODO: add strata.
        method = "chisq" # TODO: add flexibility.
      )

      data.frame(
        arm = " ", # dummy column needed for nested header.
        n_tot = unname(result_all$n_prop[1]),
        or = unname(result_odds_ratio$or_ci["est"]),
        lcl = unname(result_odds_ratio$or_ci["lcl"]),
        ucl = unname(result_odds_ratio$or_ci["ucl"]),
        pval = unname(result_test$pval),
        conf_int = 0.95,
        stringsAsFactors = FALSE
      )
    })

    df <- do.call(rbind, l_df)
    df$row_label <- names(l_df)
    df$var <- subset_i
    df$var_label <- subset_labels[subset_i]
    df
  })
  result <- do.call(rbind, l_result)
  row.names(result) <- NULL

  result
}

h_extract_subgroup_or(variables = list(rsp = "rsp", arm = "ARM", subsets = c("SEX", "BMRKR2")), data = adrs)

h_extract_subgroup_prop <- function(variables, data) {
  assertthat::assert_that(
    is.character(variables$rsp),
    is.character(variables$arm),
    is.character(variables$subsets),
    is_df_with_variables(data, as.list(unlist(variables)))
  )

  rsp <- variables$rsp
  arm <- variables$arm
  arm_ref <- levels(data[[arm]])[1]
  subset_labels <- formatable::var_labels(data[, variables$subsets], fill = TRUE)

  l_result <- lapply(variables$subsets, function(subset_i) {
    l_data <- split(data, data[[subset_i]])

    l_df <- lapply(l_data, function(df) {
      df_comp <- df[df[[arm]] == arm_ref, ]
      df_ref <- df[df[[arm]] != arm_ref, ]

      result_ref <- s_proportion(df_ref[[rsp]])
      result_comp <- s_proportion(df_comp[[rsp]])

      rbind(
        data.frame(
          arm = arm_ref,
          n = unname(result_ref$n_prop[1]),
          rsp = unname(result_ref$n_prop[2]),
          stringsAsFactors = FALSE
        ),
        data.frame(
          arm = levels(df[[arm]])[2],
          n = unname(result_comp$n_prop[1]),
          rsp = unname(result_comp$n_prop[2]),
          stringsAsFactors = FALSE
        )
      )
    })

    df <- do.call(rbind, l_df)
    df$row_label <- rep(names(l_df), each = 2)
    df$var <- subset_i
    df$var_label <- subset_labels[subset_i]

    df
  })

  result <- do.call(rbind, l_result)
  row.names(result) <- NULL
  result
}

h_extract_subgroup_prop(variables = list(rsp = "rsp", arm = "ARM", subsets = c("SEX", "BMRKR2")), data = adrs)

# Wrapper.
h_extract_subgroup_rsp <- function(variables, data) {
  df_prop <- h_extract_subgroup_prop(variables, data)
  df_or <- h_extract_subgroup_or(variables, data)

  list(prop = df_prop, or = df_or)
}

l_df <- h_extract_subgroup_rsp(variables = list(rsp = "rsp", arm = "ARM", subsets = c("SEX", "BMRKR2")), data = adrs)
l_df
```


## Formatting

- Using custom Formatted Analysis function list until more guidance on approach to create one using `make_afun`.

- Getting error when passing the format `format_pct` to the `rsp` function

```{r, utils}
# Add custom format.
format_pct <- function(x, ...) {
  attr(x, "label") <- NULL

  if (any(is.na(x))) {
    return("NA")
  }

  assertthat::assert_that(
    is.vector(x),
    is_proportion(x, include_boundaries = TRUE)
  )

  result <- paste0("(", round(x * 100, 1), "%)")
  return(result)
}
format_pct(0.3)

combine_vectors <- function(x, y) {
  lapply(as.data.frame(rbind(x, y)), `c`)
}

a_subgroup_rsp_list_manual <- list(
  n = function(df, ...) {
    in_rows(.list = as.list(df$n), .labels = as.character(df$row_label), .formats = "xx.")
  },
  rsp = function(df, ...) {
    # ERROR with .formats = format_pct.
    in_rows(.list = as.list(df$rsp), .labels = as.character(df$row_label), .formats = "xx.x%")
  },
  n_tot = function(df, ...) {
    in_rows(.list = as.list(df$n_tot), .labels = as.character(df$row_label), .formats = "xx.")
  },
  or = function(df, ...) {
    in_rows(.list = as.list(df$or), .labels = as.character(df$row_label), .formats = "xx.xx")
  },
  ci = function(df, ...) {
    in_rows(.list = combine_vectors(df$lcl, df$ucl), .labels = as.character(df$row_label), .formats = "(xx.xx, xx.xx)")
  }
)
```


## Layout

```{r, lyt_example}

t1 <- basic_table() %>%
  split_cols_by("arm") %>%
  split_cols_by_multivar(
    vars = c("n", "rsp"),
    varlabels = c("n", "Response (%)")
  ) %>%
  split_rows_by("var_label") %>%
  analyze_colvars(afun = a_subgroup_rsp_list_manual[c("n", "rsp")]) %>%
  build_table(l_df$prop)
t1

t2 <- basic_table() %>%
  split_cols_by("arm") %>%
  split_cols_by_multivar(
    vars = c("n_tot", "or", "conf_int"),
    varlabels = c("Total n", "Odds Ratio", "(95% CI)")
  ) %>%
  split_rows_by("var_label") %>%
  analyze_colvars(afun = a_subgroup_rsp_list_manual[c("n_tot", "or", "ci")]) %>%
  build_table(l_df$or)
t2

# Test cbind
cbind_rtables(t1, t2)
```

Some issues still with `cbind`, below statement gives error.
```{r, eval = FALSE}

cbind_rtables(t2[, 1], t1, t2[, 2:3])
```

Can get the right table content when using `cbind_rtables` in two steps but the header is wrong.

```{r, cbind}

cbind_rtables(
  cbind_rtables(t2[, 1], t1),
  t2[, 2:3]
)
```

## Still to do:
- Adjust formatting for extreme values.
- Adjust CI level.
- Include “All Patients” row on each page of output. (Will use rbind unless there is equivalent of `summarize_row_groups` available.)
- Add option to display p-values.
