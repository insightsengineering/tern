title: "Design for AET01_AESI"
author: "Yuliia Bahatska"
date: "`r Sys.Date()`"
output:
  html_document:
  toc: true
toc_float: true
toc_depth: 2
theme: journal
highlight: zenburn
vignette: >
  %\VignetteIndexEntry{Design of AET01_AESI}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---
  
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

## Configuration

  
```{r setup}
library(dplyr)
library(tern)
packageVersion("tern")
packageVersion("rtables")
```

##Data for examples

  
```{r data, results = "asis", eval = TRUE}

library(tern)
library(dplyr)

adsl <- haven::read_sas(data_file = "adsl.sas7bdat")
adae <- haven::read_sas(data_file = "adae.sas7bdat")

adsl <- filter(adsl, SAFFL == "Y")
adae <- filter(adae, (!is.na(AEBODSYS) | !is.na(AEDECOD)) & ANL01FL == "Y" & SAFFL == "Y")

adae <- df_explicit_na(adae)
adsl <- df_explicit_na(adsl)

# variables not in rcd ADAE: AECONTRT

adae <- adae %>%
  mutate(
    AEDECOD = as.character(AEDECOD),
    WD = AEACN == "DRUG WITHDRAWN",
    DSM = AEACN %in% c("DRUG INTERRUPTED", "DOSE INCREASED", "DOSE REDUCED"),
    CONTRT = AECONTRT == "Y",
    SER = AESER == "Y",
    REL = AEREL == "Y",
    ALL_RESOLVED_WD = WD == TRUE & AEOUT == "RECOVERED/RESOLVED",
    ALL_RESOLVED_DSM = DSM == TRUE & AEOUT == "RECOVERED/RESOLVED",
    ALL_RESOLVED_CONTRT = CONTRT == TRUE & AEOUT == "RECOVERED/RESOLVED",
    NOT_RESOLVED_WD = WD == TRUE & AEOUT != "RECOVERED/RESOLVED",
    NOT_RESOLVED_DSM = DSM == TRUE & AEOUT != "RECOVERED/RESOLVED",
    NOT_RESOLVED_CONTRT = CONTRT == TRUE & AEOUT != "RECOVERED/RESOLVED",
    SERWD = AESER == "Y" & AEACN == "DRUG WITHDRAWN",
    SERCONTRT = AECONTRT == "Y" & AESER == "Y",
    SERDSM = AESER == "Y" & AEACN %in% c("DRUG INTERRUPTED", "DOSE INCREASED", "DOSE REDUCED"),
    RELWD = AEREL == "Y" & AEACN == "DRUG WITHDRAWN",
    RELDSM = AEREL == "Y" & AEACN %in% c("DRUG INTERRUPTED", "DOSE INCREASED", "DOSE REDUCED"),
    RELCONTRT = AECONTRT == "Y" & AEREL == "Y",
    RELSER = AESER == "Y" & AEREL == "Y",
    USUBJID_AESEQ = paste(USUBJID, AESEQ, sep = "@@") # Create unique ID per AE in dataset.
  ) %>%
  var_relabel(
    WD = "Total number of patients with study drug withdrawn due to AE",
    DSM = "Total number of patients with dose modified/interrupted due to AE",
    CONTRT = "Total number of patients with treatment received for AE",
    SER = "Total number of patients with at least one serious AE",
    REL = "Total number of patients with at least one related AE",
    ALL_RESOLVED_WD = "No. of patients with study drug withdrawn due to resolved AE",
    ALL_RESOLVED_DSM = "No. of patients with dose modified/interrupted due to resolved AE",
    ALL_RESOLVED_CONTRT = "No. of patients with treatment received for resolved AE",
    NOT_RESOLVED_WD = "No. of patients with study drug withdrawn due to unresolved or ongoing AE",
    NOT_RESOLVED_DSM = "No. of patients with dose modified/interrupted due to unresolved or ongoing AE",
    NOT_RESOLVED_CONTRT = "No. of patients with treatment received for unresolved or ongoing AE",
    SERWD = "No. of patients with study drug withdrawn due to serious AE",
    SERDSM = "No. of patients with dose modified/interrupted due to serious AE",
    SERCONTRT = "No. of patients with treatment received for serious AE",
    RELWD = "No. of patients with study drug withdrawn due to related AE",
    RELDSM = "No. of patients with dose modified/interrupted due to related AE",
    RELCONTRT = "No. of patients with treatment received for related AE",
    RELSER = "No. of patients with serious, related AE"
  )

not_resolved <- adae %>%
  filter(AEOUT != "RECOVERED/RESOLVED" & AEOUT != "FATAL") %>%
  select(unique("USUBJID")) %>%
  mutate(
    NOT_RESOLVED = "Y"
  )
adae <- adae %>%
  left_join(not_resolved, by = c("USUBJID")) %>%
  mutate(
    ALL_RESOLVED = is.na(NOT_RESOLVED),
    NOT_RESOLVED = !is.na(NOT_RESOLVED)
  ) %>%
  var_relabel(
    ALL_RESOLVED = "Total number of patients with all non-fatal AEs resolved",
    NOT_RESOLVED = "Total number of patients with at least one non-fatal unresolved or ongoing AE"
  )

df_max <- aggregate(as.numeric(AETOXGR) ~ USUBJID, data = adae, FUN = max, drop = FALSE)

colnames(df_max) <- c("USUBJID", "WTOXGR")

adae <- adae %>%
  left_join(df_max, by = c("USUBJID")) %>%
  mutate(
    WTOXGR = factor(WTOXGR, levels = c("1", "2", "3", "4", "5"))
  ) %>%
  mutate(
    WTOXGR = forcats::fct_recode(WTOXGR,
      "Grade 1" = "1",
      "Grade 2" = "2",
      "Grade 3" = "3",
      "Grade 4" = "4",
      "Grade 5 (fatal outcome)" = "5"
    )
  ) %>%
  var_relabel(
    WTOXGR = "Total number of patients with at least one AE by worst grade"
  )


aesi_vars <- c("WD", "DSM", "CONTRT", "ALL_RESOLVED", "NOT_RESOLVED", "SER", "REL")
```

##New function to summarize grades and display labels

```{r}
count_occurrences_by_grade_label <- function(lyt, # nolint
                                             var,
                                             var_labels = var,
                                             ...,
                                             table_names = var,
                                             show_labels = "default",
                                             .stats = NULL,
                                             .formats = NULL,
                                             .indent_mods = NULL,
                                             .labels = NULL) {
  afun <- make_afun(
    a_count_occurrences_by_grade,
    .stats = .stats,
    .formats = .formats,
    .indent_mods = .indent_mods,
    .ungroup_stats = "count_fraction"
  )
  analyze(
    lyt = lyt,
    vars = var,
    afun = afun,
    table_names = table_names,
    var_labels = var_labels,
    show_labels = show_labels,
    extra_args = list(...)
  )
}
```

## Layout for variables from adae dataset
```{r}
lyt_adae <- basic_table() %>%
  split_cols_by("ACTARM") %>%
  add_colcounts() %>%
  count_patients_with_event(
    vars = "USUBJID",
    filters = c("STUDYID" = as.character(unique(adae$STUDYID))),
    denom = "N_col",
    .labels = c(count_fraction = "Total number of patients with at least one AE")
  ) %>%
  count_values(
    "STUDYID",
    values = as.character(unique(adae$STUDYID)),
    .stats = "count",
    .labels = c(count = "Total number of AEs"),
    table_names = "total_aes"
  ) %>%
  count_occurrences_by_grade_label(
    var = "WTOXGR",
    var_labels = "Total number of patients with at least one AE by worst grade",
    .show_labels = "visible"
  ) %>%
  count_patients_with_flags(
    "USUBJID",
    flag_variables = formatters::var_labels(adae[, aesi_vars])
  )
result_adae <- build_table(lyt_adae, df = adae, alt_counts_df = adsl)
result <- insert_rrow(result_adae, rrow("Total number of patients with at least one AE by worst grade ", ""), at = 3)
result_adae

# In case of multiple drugs use AEREL1-X, AEACN1-X
```

##AEs by SMQ
```{r}
stack_adae_by_smq <- function(adae, smq) {
  adae_labels <- c(formatters::var_labels(adae), "Standardized MedDRA Query")
  l_df <- lapply(smq, function(ae_grp) {
    ae_scope <- str_replace(ae_grp, "NAM", "SC")
    keep <- adae[[ae_grp]] != "<Missing>"
    df <- adae[keep, ]
    if (substr(ae_grp, 1, 3) == "SMQ") {
      df[["SMQ"]] <- aesi_label(as.character(df[[ae_grp]]), scope = as.character(df[[ae_scope]]))
    } else {
      df[["SMQ"]] <- df[[ae_grp]]
    }
    df
  })
  result <- do.call(rbind, l_df)
  formatters::var_labels(result) <- adae_labels
  result
}


adae_smq <- stack_adae_by_smq(adae, c("CQ01NAM", "CQ02NAM", "SMQ01NAM"))

split_fun <- remove_split_levels("<Missing>")
# Layout for variables from adae dataset.
lyt_adae <- basic_table() %>%
  split_cols_by("ACTARM") %>%
  add_colcounts() %>%
  split_rows_by(
    "SMQ",
    child_labels = "visible",
    nested = FALSE,
    indent_mod = -1L,
    split_fun = split_fun
  ) %>%
  append_topleft("Standardized MedDRA Query") %>%
  count_patients_with_event(
    vars = "USUBJID",
    filters = c("STUDYID" = as.character(unique(adae$STUDYID))),
    denom = "N_col",
    .labels = c(count_fraction = "Total number of patients with at least one AE")
  ) %>%
  count_values(
    "STUDYID",
    values = as.character(unique(adae$STUDYID)),
    .stats = "count",
    .labels = c(count = "Total number of AEs"),
    table_names = "total_aes"
  ) %>%
  count_occurrences_by_grade_label(
    var = "WTOXGR",
    var_labels = "Total number of patients with at least one AE by worst grade",
    .show_labels = "visible"
  ) %>%
  count_patients_with_flags(
    "USUBJID",
    flag_variables = formatters::var_labels(adae[, aesi_vars])
  )
result_adae <- build_table(lyt_adae, df = adae_smq, alt_counts_df = adsl)
result_adae
```
