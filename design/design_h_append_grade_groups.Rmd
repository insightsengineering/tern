---
title: "Design for h_append_grade_group refactoring"
author: "Rosemary Li"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    theme: journal
    highlight: zenburn
vignette: >
  %\VignetteIndexEntry{Design of AET04}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

Configuration
=============

```{r setup}
library(rtables)
library(tern)
library(assertthat)
library(dplyr)

packageVersion("tern")
packageVersion("rtables")
```

Data for examples
=================

```{r data, results = "asis", eval = TRUE}
grade_groups <- list(
  "Any Grade" = as.character(1:5),
  "Grade 1-2" = c("1", "2"),
  "Grade 3-4" = c("3", "4")
)

refs <- list("1" = 10, "2" = 20, "3" = 30, "4" = 40)

h_append_grade_groups(grade_groups, refs)
```


### h_append_grade_groups

```{r, sfun}
h_append_grade_groups <- function(grade_groups, refs, remove_single = TRUE) {

  assert_that(
    is.list(grade_groups),
    is.list(refs)
  )
  elements <- unique(unlist(grade_groups))

  ### compute sums in groups
  grp_sum <- lapply(grade_groups, function(i) do.call(sum, refs[i]))
  if (!all_elements_in_ref(elements, names(refs))) {
    padding_el <- setdiff(elements, names(refs))
    refs[padding_el] <- 0
  }
  result <- c(grp_sum, refs)

  ### order result while keeping grade_groups's ordering
  ordr <- grade_groups

  # elements of any-grade group (if any) will be moved to the end
  is_any <- sapply(grade_groups, setequal, y = names(refs))
  ordr[is_any] <- list(character(0)) # hide elements under any-grade group

  # groups-elements combined sequence
  ordr <- c(lapply(names(ordr), function(g) c(g, ordr[[g]])), recursive = TRUE, use.names = FALSE)
  ordr <- ordr[!duplicated(ordr)]

  # append remaining elements (if any)
  ordr <- union(ordr, unlist(grade_groups[is_any])) # from any-grade group
  ordr <- union(ordr, names(refs)) # from refs

  # remove elements of single-element groups, if any
  if (remove_single) {
    is_single <- sapply(grade_groups, length) == 1L
    ordr <- setdiff(ordr, unlist(grade_groups[is_single]))
  }

  # apply the order
  result <- result[ordr]
  result

}
```

### s_count_occurrences_by_grade

```{r}
 df <- data.frame(
   USUBJID = as.character(c(1:6, 1)),
   ARM = factor(c("A", "A", "A", "B", "B", "B", "A"), levels = c("A", "B")),
   AETOXGR = factor(c(1, 2, 3, 4, 1, 2, 3), levels = c(1:4)),
   AESEV = factor(
     x = c("MILD", "MODERATE", "SEVERE", "MILD",  "MILD", "MODERATE", "SEVERE"),
     levels = c("MILD", "MODERATE", "SEVERE")
   ),
   stringsAsFactors = FALSE
 )

 df_adsl <- df %>%
   select(USUBJID, ARM) %>%
   unique
 
 s_count_occurrences_by_grade(
   df,
   .N_col = 10L, # nolint
   .var = "AETOXGR",
   id = "USUBJID",
   grade_groups = grade_groups
 )
```


```{r}
 grade_groups <-  list(
   "-Any-" = c("1", "2", "3", "4", "5"),
   "Grade 1-2" = c("1", "2"),
   "Grade 3-5" = c("3", "4", "5")
 )

 basic_table() %>%
   split_cols_by("ARM") %>%
   add_colcounts() %>%
   count_occurrences_by_grade(
     var = "AETOXGR",
     grade_groups = grade_groups
   ) %>%
   build_table(df, alt_counts_df = df_adsl)
```

