---
title: "Design for h_append_grade_group refactoring"
author: "Rosemary Li"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    theme: journal
    highlight: zenburn
vignette: >
  %\VignetteIndexEntry{Design of AET04}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

Configuration
=============

```{r setup}
library(rtables)
library(tern)
library(assertthat)
library(dplyr)

packageVersion("tern")
packageVersion("rtables")
```

Data for examples
=================

### h_append_grade_groups

```{r, sfun}
h_append_grade_groups <- function(grade_groups, refs, remove_single = TRUE) {

  assert_that(
    is.list(grade_groups),
    is.list(refs)
  )
  elements <- unique(unlist(grade_groups))

  ### compute sums in groups
  grp_sum <- lapply(grade_groups, function(i) do.call(sum, refs[i]))
  if (!all_elements_in_ref(elements, names(refs))) {
    padding_el <- setdiff(elements, names(refs))
    refs[padding_el] <- 0
  }
  result <- c(grp_sum, refs)

  ### order result while keeping grade_groups's ordering
  ordr <- grade_groups

  # elements of any-grade group (if any) will be moved to the end
  is_any <- sapply(grade_groups, setequal, y = names(refs))
  ordr[is_any] <- list(character(0)) # hide elements under any-grade group

  # groups-elements combined sequence
  ordr <- c(lapply(names(ordr), function(g) c(g, ordr[[g]])), recursive = TRUE, use.names = FALSE)
  ordr <- ordr[!duplicated(ordr)]

  # append remaining elements (if any)
  ordr <- union(ordr, unlist(grade_groups[is_any])) # from any-grade group
  ordr <- union(ordr, names(refs)) # from refs

  # remove elements of single-element groups, if any
  if (remove_single) {
    is_single <- sapply(grade_groups, length) == 1L
    ordr <- setdiff(ordr, unlist(grade_groups[is_single]))
  }

  # apply the order
  result <- result[ordr]
  
  #remove zeros
  # keep_el <- lapply(result, function(x) {x != 0})
  # keep_el <- c(keep_el, recursive = TRUE, use.names = FALSE)
  # result <- result[keep_el]
  
  result

}
```

```{r data, results = "asis", eval = TRUE}
grade_groups <- list(
  "Any Grade" = as.character(1:5),
  "Grade 1-2" = c("1", "2"),
  "Grade 3-4" = c("3", "4")
)

refs <- list("1" = 10, "2" = 20)

h_append_grade_groups(grade_groups, refs)
```

example

```{r}
df <- data.frame(
  USUBJID = as.character(1:30),
  ARM = factor(c(rep("ARM A", 15), rep("ARM B", 15)), levels = c("ARM A", "ARM B")),
  SOC = as.factor(rep("SOC1", 30)),
  AETOXGR = factor(c(rep(1, 10), rep(2, 20)) , levels = c(1, 2))
)

 df_adsl <- df %>%
   select(USUBJID, ARM) %>%
   unique

 # s_count_occurrences_by_grade(
 #   df,
 #   .N_col = 30L, # nolint
 #   .var = "AETOXGR",
 #   id = "USUBJID",
 #   grade_groups = grade_groups
 # )
 
 
 basic_table() %>%
   split_cols_by("ARM") %>%
   add_colcounts() %>%
   split_rows_by("SOC", split_fun = trim_levels_in_group("AETOXGR")) %>%
   count_occurrences_by_grade(
     var = "AETOXGR",
     grade_groups = grade_groups
   ) %>%
   build_table(df, alt_counts_df = df_adsl)
```

### check with STREAM AET03
```{r}
adsl <- haven::read_sas("../adsl.sas7bdat")
adae <- haven::read_sas("../adae.sas7bdat")

adsl <- adsl %>% filter(SAFFL == "Y") %>% df_explicit_na()
adae <- adae %>% filter(ANL01FL == "Y") %>% df_explicit_na()
```

old way
```{r}
start_time <- Sys.time()
grade_groups<-  list(
  "- Any Intensity -" = c("MILD", "MODERATE", "SEVERE", "LIFE THREATENING")
)  

split_fun <- drop_split_levels

lyt <- basic_table() %>%
  split_cols_by("ACTARM") %>%
  add_colcounts() %>%
  summarize_occurrences_by_grade(
    var = "ASEV",
    grade_groups = grade_groups
  ) %>%
  split_rows_by(
    "AEBODSYS", 
    child_labels = "visible", 
    nested = TRUE, 
    indent_mod = -1L,
    split_fun = split_fun,
    label_pos = "topleft",
    split_label = obj_label(adae$AEBODSYS)
    ) %>%
  summarize_occurrences_by_grade(
    var = "ASEV",
    grade_groups = grade_groups
  ) %>%
  split_rows_by(
    "AEDECOD", 
    child_labels = "visible", 
    nested = TRUE, 
    indent_mod = -1L,
    split_fun = split_fun,
    label_pos = "topleft",
    split_label = obj_label(adae$AEDECOD)
    ) %>%
  summarize_num_patients(
    var = "USUBJID",
    .stats = "unique",
    .labels = c("- Any Intensity -")
  ) %>%
  count_occurrences_by_grade(
    var = "ASEV", 
    .indent_mods = -1L
    ) %>%
  append_varlabels(adae, "ASEV", indent = 2L)


result <- lyt %>%
  build_table(
    adae,
    alt_counts_df = adsl
    ) %>%
  trim_rows() %>%
  sort_at_path(
    path = "AEBODSYS",
    scorefun = cont_n_allcols,
    decreasing = TRUE
  ) %>%
  sort_at_path(
    path = c("AEBODSYS", "*", "AEDECOD"),
    scorefun = cont_n_allcols,
    decreasing = TRUE
  )

end_time <- Sys.time()
print(end_time - start_time)
```

new way
```{r}
start_time <- Sys.time()
grade_groups<-  list(
  "- Any Intensity -" = c("MILD", "MODERATE", "SEVERE", "LIFE THREATENING")
)  

split_fun <- trim_levels_in_group("ASEV")

lyt <- basic_table() %>%
  split_cols_by("ACTARM") %>%
  add_colcounts() %>%
  summarize_occurrences_by_grade(
    var = "ASEV",
    grade_groups = grade_groups
  ) %>%
  split_rows_by(
    "AEBODSYS", 
    child_labels = "visible", 
    nested = TRUE, 
    indent_mod = -1L,
    split_fun = split_fun,
    label_pos = "topleft",
    split_label = obj_label(adae$AEBODSYS)
    ) %>%
  summarize_occurrences_by_grade(
    var = "ASEV",
    grade_groups = grade_groups
  ) %>%
  split_rows_by(
    "AEDECOD", 
    child_labels = "visible", 
    nested = TRUE, 
    indent_mod = -1L,
    split_fun = split_fun,
    label_pos = "topleft",
    split_label = obj_label(adae$AEDECOD)
    ) %>%
  summarize_num_patients(
    var = "USUBJID",
    .stats = "unique",
    .labels = c("- Any Intensity -")
  ) %>%
  count_occurrences_by_grade(
    var = "ASEV", 
    .indent_mods = -1L
    ) %>%
  append_varlabels(adae, "ASEV", indent = 2L)


result <- lyt %>%
  build_table(
    adae,
    alt_counts_df = adsl
    ) %>%
  trim_rows() %>%
  sort_at_path(
    path = "AEBODSYS",
    scorefun = cont_n_allcols,
    decreasing = TRUE
  ) %>%
  sort_at_path(
    path = c("AEBODSYS", "*", "AEDECOD"),
    scorefun = cont_n_allcols,
    decreasing = TRUE
  )

end_time <- Sys.time()
print(end_time - start_time)
```


### check with STREAM AET04

old way
```{r}
start_time <- Sys.time()
gr_grp <-  list(
  "- Any Grade -" = c("1", "2", "3", "4", "5"),
  "Grade 1-2" = c("1", "2"),
  "Grade 3-4" = c("3", "4"),
  "Grade 5" = "5"
)

split_fun <- drop_split_levels

lyt <- basic_table() %>%
  split_cols_by("ACTARM") %>%
  add_colcounts() %>%
  summarize_occurrences_by_grade(
    var = "AETOXGR",
    grade_groups = gr_grp
  ) %>%
  split_rows_by(
    "AEBODSYS", 
    child_labels = "visible", 
    nested = TRUE, 
    indent_mod = -1L,
    split_fun = split_fun,
    label_pos = "topleft",
    split_label = obj_label(adae$AEBODSYS)
  ) %>%
  summarize_occurrences_by_grade(
    var = "AETOXGR",
    grade_groups = gr_grp
  ) %>%
  split_rows_by(
    "AEDECOD", 
    child_labels = "visible", 
    nested = TRUE, 
    indent_mod = -1L,
    split_fun = split_fun,
    label_pos = "topleft",
    split_label = obj_label(adae$AEDECOD)
  ) %>%
  summarize_num_patients(
    var = "USUBJID",
    .stats = "unique",
    .labels = "- Any Grade -"
  ) %>%
  count_occurrences_by_grade(
    var = "AETOXGR",
    grade_groups = gr_grp[-1],
    .indent_mods = -1L
  ) %>%
  append_varlabels(adae, "AETOXGR", indent = 2L)

result <- lyt %>%
  build_table(adae, alt_counts_df = adsl) %>%
  trim_rows() %>%
  sort_at_path(
    path = "AEBODSYS",
    scorefun = cont_n_allcols,
    decreasing = TRUE
  ) %>%
  sort_at_path(
    path = c("AEBODSYS", "*", "AEDECOD"),
    scorefun = cont_n_allcols,
    decreasing = TRUE
  )
end_time <- Sys.time()
print(end_time - start_time)
```

new way
```{r}
start_time <- Sys.time()
gr_grp <-  list(
  "- Any Grade -" = c("1", "2", "3", "4", "5"),
  "Grade 1-2" = c("1", "2"),
  "Grade 3-4" = c("3", "4"),
  "Grade 5" = "5"
)

split_fun <- trim_levels_in_group("AETOXGR")

lyt <- basic_table() %>%
  split_cols_by("ACTARM") %>%
  add_colcounts() %>%
  summarize_occurrences_by_grade(
    var = "AETOXGR",
    grade_groups = gr_grp
  ) %>%
  split_rows_by(
    "AEBODSYS", 
    child_labels = "visible", 
    nested = TRUE, 
    indent_mod = -1L,
    split_fun = split_fun,
    label_pos = "topleft",
    split_label = obj_label(adae$AEBODSYS)
  ) %>%
  summarize_occurrences_by_grade(
    var = "AETOXGR",
    grade_groups = gr_grp
  ) %>%
  split_rows_by(
    "AEDECOD", 
    child_labels = "visible", 
    nested = TRUE, 
    indent_mod = -1L,
    split_fun = split_fun,
    label_pos = "topleft",
    split_label = obj_label(adae$AEDECOD)
  ) %>%
  summarize_num_patients(
    var = "USUBJID",
    .stats = "unique",
    .labels = "- Any Grade -"
  ) %>%
  count_occurrences_by_grade(
    var = "AETOXGR",
    grade_groups = gr_grp[-1],
    .indent_mods = -1L
  ) %>%
  append_varlabels(adae, "AETOXGR", indent = 2L)

result <- lyt %>%
  build_table(adae, alt_counts_df = adsl) %>%
  trim_rows() %>%
  sort_at_path(
    path = "AEBODSYS",
    scorefun = cont_n_allcols,
    decreasing = TRUE
  ) %>%
  sort_at_path(
    path = c("AEBODSYS", "*", "AEDECOD"),
    scorefun = cont_n_allcols,
    decreasing = TRUE
  )

end_time <- Sys.time()
print(end_time - start_time)
```
